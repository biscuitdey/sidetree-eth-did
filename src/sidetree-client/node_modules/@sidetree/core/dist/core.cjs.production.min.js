"use strict";function e(e){return e&&"object"==typeof e&&"default"in e?e.default:e}function r(e){if(e&&e.__esModule)return e;var r={};return e&&Object.keys(e).forEach((function(t){var n=Object.getOwnPropertyDescriptor(e,t);Object.defineProperty(r,t,n.get?n:{enumerable:!0,get:function(){return e[t]}})})),r.default=e,r}Object.defineProperty(exports,"__esModule",{value:!0});var t=require("@sidetree/common"),n=e(require("fast-json-patch")),a=require("jose"),o=require("bip39"),i=require("@transmute/did-key-ed25519"),s=e(require("hdkey")),c=require("@trust/keyto"),u=require("@transmute/did-key-secp256k1"),p=e(require("time-span")),d=require("crypto"),f=require("@sidetree/db"),h=e(require("priorityqueue")),l=e(require("chalk")),v=require("url");function m(e,r,t,n,a,o,i){try{var s=e[o](i),c=s.value}catch(e){return void t(e)}s.done?r(c):Promise.resolve(c).then(n,a)}function y(e){return function(){var r=this,t=arguments;return new Promise((function(n,a){var o=e.apply(r,t);function i(e){m(o,n,a,i,s,"next",e)}function s(e){m(o,n,a,i,s,"throw",e)}i(void 0)}))}}function w(){return(w=Object.assign||function(e){for(var r=1;r<arguments.length;r++){var t=arguments[r];for(var n in t)Object.prototype.hasOwnProperty.call(t,n)&&(e[n]=t[n])}return e}).apply(this,arguments)}function x(e,r){return(x=Object.setPrototypeOf||function(e,r){return e.__proto__=r,e})(e,r)}function b(e,r){(null==r||r>e.length)&&(r=e.length);for(var t=0,n=new Array(r);t<r;t++)n[t]=e[t];return n}function g(e,r){var t="undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(t)return(t=t.call(e)).next.bind(t);if(Array.isArray(e)||(t=function(e,r){if(e){if("string"==typeof e)return b(e,void 0);var t=Object.prototype.toString.call(e).slice(8,-1);return"Object"===t&&e.constructor&&(t=e.constructor.name),"Map"===t||"Set"===t?Array.from(e):"Arguments"===t||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(t)?b(e,void 0):void 0}}(e))||r&&e&&"number"==typeof e.length){t&&(e=t);var n=0;return function(){return n>=e.length?{done:!0}:{done:!1,value:e[n++]}}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var k,S=(function(e){var r=function(e){var r=Object.prototype,t=r.hasOwnProperty,n="function"==typeof Symbol?Symbol:{},a=n.iterator||"@@iterator",o=n.asyncIterator||"@@asyncIterator",i=n.toStringTag||"@@toStringTag";function s(e,r,t){return Object.defineProperty(e,r,{value:t,enumerable:!0,configurable:!0,writable:!0}),e[r]}try{s({},"")}catch(e){s=function(e,r,t){return e[r]=t}}function c(e,r,t,n){var a=Object.create((r&&r.prototype instanceof d?r:d).prototype),o=new S(n||[]);return a._invoke=function(e,r,t){var n="suspendedStart";return function(a,o){if("executing"===n)throw new Error("Generator is already running");if("completed"===n){if("throw"===a)throw o;return{value:void 0,done:!0}}for(t.method=a,t.arg=o;;){var i=t.delegate;if(i){var s=b(i,t);if(s){if(s===p)continue;return s}}if("next"===t.method)t.sent=t._sent=t.arg;else if("throw"===t.method){if("suspendedStart"===n)throw n="completed",t.arg;t.dispatchException(t.arg)}else"return"===t.method&&t.abrupt("return",t.arg);n="executing";var c=u(e,r,t);if("normal"===c.type){if(n=t.done?"completed":"suspendedYield",c.arg===p)continue;return{value:c.arg,done:t.done}}"throw"===c.type&&(n="completed",t.method="throw",t.arg=c.arg)}}}(e,t,o),a}function u(e,r,t){try{return{type:"normal",arg:e.call(r,t)}}catch(e){return{type:"throw",arg:e}}}e.wrap=c;var p={};function d(){}function f(){}function h(){}var l={};l[a]=function(){return this};var v=Object.getPrototypeOf,m=v&&v(v(E([])));m&&m!==r&&t.call(m,a)&&(l=m);var y=h.prototype=d.prototype=Object.create(l);function w(e){["next","throw","return"].forEach((function(r){s(e,r,(function(e){return this._invoke(r,e)}))}))}function x(e,r){var n;this._invoke=function(a,o){function i(){return new r((function(n,i){!function n(a,o,i,s){var c=u(e[a],e,o);if("throw"!==c.type){var p=c.arg,d=p.value;return d&&"object"==typeof d&&t.call(d,"__await")?r.resolve(d.__await).then((function(e){n("next",e,i,s)}),(function(e){n("throw",e,i,s)})):r.resolve(d).then((function(e){p.value=e,i(p)}),(function(e){return n("throw",e,i,s)}))}s(c.arg)}(a,o,n,i)}))}return n=n?n.then(i,i):i()}}function b(e,r){var t=e.iterator[r.method];if(void 0===t){if(r.delegate=null,"throw"===r.method){if(e.iterator.return&&(r.method="return",r.arg=void 0,b(e,r),"throw"===r.method))return p;r.method="throw",r.arg=new TypeError("The iterator does not provide a 'throw' method")}return p}var n=u(t,e.iterator,r.arg);if("throw"===n.type)return r.method="throw",r.arg=n.arg,r.delegate=null,p;var a=n.arg;return a?a.done?(r[e.resultName]=a.value,r.next=e.nextLoc,"return"!==r.method&&(r.method="next",r.arg=void 0),r.delegate=null,p):a:(r.method="throw",r.arg=new TypeError("iterator result is not an object"),r.delegate=null,p)}function g(e){var r={tryLoc:e[0]};1 in e&&(r.catchLoc=e[1]),2 in e&&(r.finallyLoc=e[2],r.afterLoc=e[3]),this.tryEntries.push(r)}function k(e){var r=e.completion||{};r.type="normal",delete r.arg,e.completion=r}function S(e){this.tryEntries=[{tryLoc:"root"}],e.forEach(g,this),this.reset(!0)}function E(e){if(e){var r=e[a];if(r)return r.call(e);if("function"==typeof e.next)return e;if(!isNaN(e.length)){var n=-1,o=function r(){for(;++n<e.length;)if(t.call(e,n))return r.value=e[n],r.done=!1,r;return r.value=void 0,r.done=!0,r};return o.next=o}}return{next:O}}function O(){return{value:void 0,done:!0}}return f.prototype=y.constructor=h,h.constructor=f,f.displayName=s(h,i,"GeneratorFunction"),e.isGeneratorFunction=function(e){var r="function"==typeof e&&e.constructor;return!!r&&(r===f||"GeneratorFunction"===(r.displayName||r.name))},e.mark=function(e){return Object.setPrototypeOf?Object.setPrototypeOf(e,h):(e.__proto__=h,s(e,i,"GeneratorFunction")),e.prototype=Object.create(y),e},e.awrap=function(e){return{__await:e}},w(x.prototype),x.prototype[o]=function(){return this},e.AsyncIterator=x,e.async=function(r,t,n,a,o){void 0===o&&(o=Promise);var i=new x(c(r,t,n,a),o);return e.isGeneratorFunction(t)?i:i.next().then((function(e){return e.done?e.value:i.next()}))},w(y),s(y,i,"Generator"),y[a]=function(){return this},y.toString=function(){return"[object Generator]"},e.keys=function(e){var r=[];for(var t in e)r.push(t);return r.reverse(),function t(){for(;r.length;){var n=r.pop();if(n in e)return t.value=n,t.done=!1,t}return t.done=!0,t}},e.values=E,S.prototype={constructor:S,reset:function(e){if(this.prev=0,this.next=0,this.sent=this._sent=void 0,this.done=!1,this.delegate=null,this.method="next",this.arg=void 0,this.tryEntries.forEach(k),!e)for(var r in this)"t"===r.charAt(0)&&t.call(this,r)&&!isNaN(+r.slice(1))&&(this[r]=void 0)},stop:function(){this.done=!0;var e=this.tryEntries[0].completion;if("throw"===e.type)throw e.arg;return this.rval},dispatchException:function(e){if(this.done)throw e;var r=this;function n(t,n){return i.type="throw",i.arg=e,r.next=t,n&&(r.method="next",r.arg=void 0),!!n}for(var a=this.tryEntries.length-1;a>=0;--a){var o=this.tryEntries[a],i=o.completion;if("root"===o.tryLoc)return n("end");if(o.tryLoc<=this.prev){var s=t.call(o,"catchLoc"),c=t.call(o,"finallyLoc");if(s&&c){if(this.prev<o.catchLoc)return n(o.catchLoc,!0);if(this.prev<o.finallyLoc)return n(o.finallyLoc)}else if(s){if(this.prev<o.catchLoc)return n(o.catchLoc,!0)}else{if(!c)throw new Error("try statement without catch or finally");if(this.prev<o.finallyLoc)return n(o.finallyLoc)}}}},abrupt:function(e,r){for(var n=this.tryEntries.length-1;n>=0;--n){var a=this.tryEntries[n];if(a.tryLoc<=this.prev&&t.call(a,"finallyLoc")&&this.prev<a.finallyLoc){var o=a;break}}o&&("break"===e||"continue"===e)&&o.tryLoc<=r&&r<=o.finallyLoc&&(o=null);var i=o?o.completion:{};return i.type=e,i.arg=r,o?(this.method="next",this.next=o.finallyLoc,p):this.complete(i)},complete:function(e,r){if("throw"===e.type)throw e.arg;return"break"===e.type||"continue"===e.type?this.next=e.arg:"return"===e.type?(this.rval=this.arg=e.arg,this.method="return",this.next="end"):"normal"===e.type&&r&&(this.next=r),p},finish:function(e){for(var r=this.tryEntries.length-1;r>=0;--r){var t=this.tryEntries[r];if(t.finallyLoc===e)return this.complete(t.completion,t.afterLoc),k(t),p}},catch:function(e){for(var r=this.tryEntries.length-1;r>=0;--r){var t=this.tryEntries[r];if(t.tryLoc===e){var n=t.completion;if("throw"===n.type){var a=n.arg;k(t)}return a}}throw new Error("illegal catch attempt")},delegateYield:function(e,r,t){return this.delegate={iterator:E(e),resultName:r,nextLoc:t},"next"===this.method&&(this.arg=void 0),p}},e}(e.exports);try{regeneratorRuntime=r}catch(e){Function("r","regeneratorRuntime = r")(r)}}(k={exports:{}}),k.exports),E=function(){function e(){}return e.hasDuplicates=function(e){for(var r=new Set,t=0;t<e.length;t++){var n=e[t];if(r.has(n))return!0;r.add(n)}return!1},e.areMutuallyExclusive=function(e,r){for(var t,n=new Set(e),a=g(r);!(t=a()).done;)if(n.has(t.value))return!1;return!0},e}(),O=require("pako"),P=function(){function e(){}return e.compress=function(){var e=y(S.mark((function e(r){var t;return S.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return t=O.deflate(Buffer.from(r)),e.abrupt("return",Buffer.from(t));case 2:case"end":return e.stop()}}),e)})));return function(r){return e.apply(this,arguments)}}(),e.decompress=function(){var e=y(S.mark((function e(r){var t;return S.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return t=O.inflate(r),e.abrupt("return",Buffer.from(t));case 2:case"end":return e.stop()}}),e)})));return function(r){return e.apply(this,arguments)}}(),e}(),C=function(){function e(){}return e.transformToExternalDocument=function(e,r){if(void 0===e.nextRecoveryCommitmentHash)return{status:"deactivated"};var n=e.document,a=r.split("?")[0],o=[],i=[],s=[],c=[],u=[],p=[];if(Array.isArray(n.public_keys))for(var d,f=g(n.public_keys);!(d=f()).done;){var h=d.value,l="#"+h.id,v={id:l,controller:a,type:h.type,publicKeyJwk:h.jwk},m=new Set(h.purpose);m.has(t.PublicKeyPurpose.General)?(p.push(v),m.has(t.PublicKeyPurpose.Auth)&&o.push(l),m.has(t.PublicKeyPurpose.AssertionMethod)&&i.push(l),m.has(t.PublicKeyPurpose.CapabilityInvocation)&&s.push(l),m.has(t.PublicKeyPurpose.CapabilityDelegation)&&c.push(l),m.has(t.PublicKeyPurpose.KeyAgreement)&&u.push(l)):m.has(t.PublicKeyPurpose.Auth)?o.push(v):m.has(t.PublicKeyPurpose.AssertionMethod)?i.push(i):m.has(t.PublicKeyPurpose.CapabilityInvocation)?s.push(v):m.has(t.PublicKeyPurpose.CapabilityDelegation)?c.push(v):m.has(t.PublicKeyPurpose.KeyAgreement)&&u.push(v)}var y=[];if(Array.isArray(n.service_endpoints))for(var w,x=g(n.service_endpoints);!(w=x()).done;){var b=w.value;y.push({id:"#"+b.id,type:b.type,serviceEndpoint:b.endpoint})}var k={id:a,"@context":["https://www.w3.org/ns/did/v1","https://ns.did.ai/transmute/v1",{"@base":a}]};return 0!==p.length&&(k.publicKey=p),0!==o.length&&(k.authentication=o),0!==i.length&&(k.assertionMethod=i),0!==s.length&&(k.capabilityInvocation=s),0!==c.length&&(k.capabilityDelegation=c),0!==u.length&&(k.keyAgreement=u),0!==y.length&&(k.service=y),JSON.parse(JSON.stringify({"@context":"https://w3id.org/did-resolution/v1",didDocument:k,didDocumentMetadata:{recoveryCommitment:e.nextRecoveryCommitmentHash,updateCommitment:e.nextUpdateCommitmentHash}}))},e.applyUpdateOperation=function(){var r=y(S.mark((function r(t,n){var a;return S.wrap((function(r){for(;;)switch(r.prev=r.next){case 0:return a=e.applyPatches(n,t.delta.patches),r.abrupt("return",a);case 2:case"end":return r.stop()}}),r)})));return function(e,t){return r.apply(this,arguments)}}(),e.validateDocument=function(r){if(void 0===r)throw new t.SidetreeError(t.ErrorCode.DocumentComposerDocumentMissing);var n=new Set(["public_keys","service_endpoints"]);for(var a in r)if(!n.has(a))throw new t.SidetreeError(t.ErrorCode.DocumentComposerUnknownPropertyInDocument,"Unexpected property "+a+" in document.");Object.prototype.hasOwnProperty.call(r,"public_keys")&&e.validatePublicKeys(r.public_keys),Object.prototype.hasOwnProperty.call(r,"service_endpoints")&&e.validateServiceEndpoints(r.service_endpoints)},e.validateDocumentPatches=function(r){if(!Array.isArray(r))throw new t.SidetreeError(t.ErrorCode.DocumentComposerUpdateOperationDocumentPatchesNotArray);for(var n,a=g(r);!(n=a()).done;)e.validatePatch(n.value)},e.validatePatch=function(r){switch(r.action){case"replace":e.validateDocument(r.document);break;case"add-public-keys":e.validateAddPublicKeysPatch(r);break;case"remove-public-keys":e.validateRemovePublicKeysPatch(r);break;case"add-service-endpoints":e.validateAddServiceEndpointsPatch(r);break;case"remove-service-endpoints":e.validateRemoveServiceEndpointsPatch(r);break;case"ietf-json-patch":e.validateIetfJsonPatch(r);break;default:throw new t.SidetreeError(t.ErrorCode.DocumentComposerPatchMissingOrUnknownAction)}},e.validateIetfJsonPatch=function(e){if(2!==Object.keys(e).length)throw new t.SidetreeError(t.ErrorCode.DocumentComposerPatchMissingOrUnknownProperty);var r=n.validate(e.patches);if(r)throw console.warn(r),new t.SidetreeError(r.name)},e.validateAddPublicKeysPatch=function(r){if(2!==Object.keys(r).length)throw new t.SidetreeError(t.ErrorCode.DocumentComposerPatchMissingOrUnknownProperty);e.validatePublicKeys(r.public_keys)},e.validatePublicKeys=function(r){if(!Array.isArray(r))throw new t.SidetreeError(t.ErrorCode.DocumentComposerPublicKeysNotArray);for(var n,a=new Set,o=g(r);!(n=o()).done;){var i=n.value;if(4!==Object.keys(i).length)throw new t.SidetreeError(t.ErrorCode.DocumentComposerPublicKeyMissingOrUnknownProperty);if("object"!=typeof i.jwk||Array.isArray(i.jwk))throw new t.SidetreeError(t.ErrorCode.DocumentComposerPublicKeyJwkMissingOrIncorrectType);if("string"!=typeof i.type)throw new t.SidetreeError(t.ErrorCode.DocumentComposerPublicKeyTypeMissingOrIncorrectType);if(e.validateId(i.id),a.has(i.id))throw new t.SidetreeError(t.ErrorCode.DocumentComposerPublicKeyIdDuplicated);if(a.add(i.id),!Array.isArray(i.purpose)||0===i.purpose.length)throw new t.SidetreeError(t.ErrorCode.DocumentComposerPublicKeyPurposeMissingOrUnknown);if(i.purpose.length>Object.values(t.PublicKeyPurpose).length)throw new t.SidetreeError(t.ErrorCode.DocumentComposerPublicKeyPurposeExceedsMaxLength);for(var s,c=new Set(Object.values(t.PublicKeyPurpose)),u=g(i.purpose);!(s=u()).done;)if(!c.has(s.value))throw new t.SidetreeError(t.ErrorCode.DocumentComposerPublicKeyInvalidPurpose)}},e.validateRemovePublicKeysPatch=function(e){if(2!==Object.keys(e).length)throw new t.SidetreeError(t.ErrorCode.DocumentComposerPatchMissingOrUnknownProperty);if(!Array.isArray(e.public_keys))throw new t.SidetreeError(t.ErrorCode.DocumentComposerPatchPublicKeyIdsNotArray);for(var r,n=g(e.public_keys);!(r=n()).done;)if("string"!=typeof r.value)throw new t.SidetreeError(t.ErrorCode.DocumentComposerPatchPublicKeyIdNotString)},e.validateRemoveServiceEndpointsPatch=function(r){if(2!==Object.keys(r).length)throw new t.SidetreeError(t.ErrorCode.DocumentComposerPatchMissingOrUnknownProperty);if(!Array.isArray(r.ids))throw new t.SidetreeError(t.ErrorCode.DocumentComposerPatchServiceEndpointIdsNotArray);for(var n,a=g(r.ids);!(n=a()).done;)e.validateId(n.value)},e.validateAddServiceEndpointsPatch=function(r){if(2!==Object.keys(r).length)throw new t.SidetreeError(t.ErrorCode.DocumentComposerPatchMissingOrUnknownProperty);if(!Array.isArray(r.service_endpoints))throw new t.SidetreeError(t.ErrorCode.DocumentComposerPatchServiceEndpointsNotArray);e.validateServiceEndpoints(r.service_endpoints)},e.validateServiceEndpoints=function(r){if(!Array.isArray(r))throw new t.SidetreeError(t.ErrorCode.DocumentComposerPatchServiceEndpointsNotArray);for(var n,a=g(r);!(n=a()).done;){var o=n.value;if(3!==Object.keys(o).length)throw new t.SidetreeError(t.ErrorCode.DocumentComposerServiceEndpointMissingOrUnknownProperty);if(e.validateId(o.id),"string"!=typeof o.type)throw new t.SidetreeError(t.ErrorCode.DocumentComposerPatchServiceEndpointTypeNotString);if(o.type.length>30)throw new t.SidetreeError(t.ErrorCode.DocumentComposerPatchServiceEndpointTypeTooLong);if("string"!=typeof o.endpoint)throw new t.SidetreeError(t.ErrorCode.DocumentComposerPatchServiceEndpointServiceEndpointNotString);if(o.endpoint.length>100)throw new t.SidetreeError(t.ErrorCode.DocumentComposerPatchServiceEndpointServiceEndpointTooLong);try{new URL(o.endpoint)}catch(e){throw new t.SidetreeError(t.ErrorCode.DocumentComposerPatchServiceEndpointServiceEndpointNotValidUrl)}}},e.validateId=function(e){if("string"!=typeof e)throw new t.SidetreeError(t.ErrorCode.DocumentComposerIdNotString,"ID not string: "+JSON.stringify(e)+" is of type '"+typeof e+"'");if(e.length>50)throw new t.SidetreeError(t.ErrorCode.DocumentComposerIdTooLong);if(!t.Encoder.isBase64UrlString(e))throw new t.SidetreeError(t.ErrorCode.DocumentComposerIdNotUsingBase64UrlCharacterSet)},e.applyPatches=function(r,t){for(var n,a=r,o=g(t);!(n=o()).done;)a=e.applyPatchToDidDocument(a,n.value);return a},e.applyPatchToDidDocument=function(r,t){return"replace"===t.action?t.document:"add-public-keys"===t.action?e.addPublicKeys(r,t):"remove-public-keys"===t.action?e.removePublicKeys(r,t):"add-service-endpoints"===t.action?e.addServiceEndpoints(r,t):"remove-service-endpoints"===t.action?e.removeServiceEndpoints(r,t):"ietf-json-patch"===t.action?e.applyIetfJsonPatch(r,t):void 0},e.applyIetfJsonPatch=function(e,r){return n.applyPatch(w({},e),r.patches).newDocument},e.addPublicKeys=function(e,r){for(var t,n=new Map((e.public_keys||[]).map((function(e){return[e.id,e]}))),a=g(r.public_keys);!(t=a()).done;){var o=t.value;n.set(o.id,o)}return e.public_keys=Array.from(n.entries()).map((function(e){return e[1]})),e},e.removePublicKeys=function(e,r){for(var t,n=new Map((e.public_keys||[]).map((function(e){return[e.id,e]}))),a=g(r.public_keys);!(t=a()).done;){var o=t.value;void 0!==n.get(o)&&n.delete(o)}return e.public_keys=Array.from(n.entries()).map((function(e){return e[1]})),e},e.addServiceEndpoints=function(e,r){var t=r.service_endpoints;void 0===e.service_endpoints&&(e.service_endpoints=[]);var n=new Map;for(var a in e.service_endpoints)n.set(e.service_endpoints[a].id,a);for(var o,i=g(t);!(o=i()).done;){var s=o.value;if(n.has(s.id)){var c=n.get(s.id);e.service_endpoints[c]=s}else e.service_endpoints.push(s)}return e},e.removeServiceEndpoints=function(e,r){if(void 0===e.service_endpoints)return e;var t=new Set(r.ids);return e.service_endpoints=e.service_endpoints.filter((function(e){return!t.has(e.id)})),e},e}(),T=require("yieldable-json"),D=function(){function e(){}return e.parse=function(){var e=y(S.mark((function e(r){var t;return S.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return t=new Promise((function(e,t){T.parseAsync(r,(function(r,n){r?t(r):e(n)}))})),e.next=3,t;case 3:return e.abrupt("return",e.sent);case 5:case"end":return e.stop()}}),e)})));return function(r){return e.apply(this,arguments)}}(),e}(),M=function(){function e(){}return e.parseDelta=function(){var e=y(S.mark((function e(r){var n,a,o;return S.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if("string"==typeof r){e.next=2;break}throw new t.SidetreeError(t.ErrorCode.DeltaMissingOrNotString);case 2:return n=t.Encoder.decodeAsString(r),e.next=5,D.parse(n);case 5:if(a=e.sent,2===Object.keys(a).length){e.next=9;break}throw new t.SidetreeError(t.ErrorCode.DeltaMissingOrUnknownProperty);case 9:if(void 0!==a.patches){e.next=11;break}throw new t.SidetreeError(t.ErrorCode.OperationDocumentPatchesMissing);case 11:return C.validateDocumentPatches(a.patches),o=t.Encoder.decodeAsBuffer(a.update_commitment),t.Multihash.verifyHashComputedUsingLatestSupportedAlgorithm(o),e.abrupt("return",{patches:a.patches,update_commitment:a.update_commitment});case 15:case"end":return e.stop()}}),e)})));return function(r){return e.apply(this,arguments)}}(),e}(),F=function(){function e(e,r,n,a,o,i){this.didUniqueSuffix=r,this.type=t.OperationType.Create,this.operationBuffer=e,this.encodedSuffixData=n,this.suffixData=a,this.encodedDelta=o,this.delta=i}return e.computeDidUniqueSuffix=function(e){var r=t.Encoder.decodeAsBuffer(e),n=t.Multihash.hash(r);return t.Encoder.encode(n)},e.parseOperationFromAnchorFile=function(){var r=y(S.mark((function r(t){var n;return S.wrap((function(r){for(;;)switch(r.prev=r.next){case 0:return n=Buffer.from(JSON.stringify(t)),r.next=3,e.parseObject(t,n,!0);case 3:return r.abrupt("return",r.sent);case 5:case"end":return r.stop()}}),r)})));return function(e){return r.apply(this,arguments)}}(),e.parse=function(){var r=y(S.mark((function r(t){var n,a;return S.wrap((function(r){for(;;)switch(r.prev=r.next){case 0:return n=t.toString(),r.next=3,D.parse(n);case 3:return a=r.sent,r.next=6,e.parseObject(a,t,!1);case 6:return r.abrupt("return",r.sent);case 8:case"end":return r.stop()}}),r)})));return function(e){return r.apply(this,arguments)}}(),e.parseObject=function(){var r=y(S.mark((function r(n,a,o){var i,s,c,u,p,d;return S.wrap((function(r){for(;;)switch(r.prev=r.next){case 0:if(i=3,o&&(i=1),Object.keys(n).length===i){r.next=5;break}throw new t.SidetreeError(t.ErrorCode.CreateOperationMissingOrUnknownProperty);case 5:return s=n.suffix_data,r.next=8,e.parseSuffixData(s);case 8:if(c=r.sent,u=void 0,p=void 0,o){r.next=23;break}if(n.type===t.OperationType.Create){r.next=14;break}throw new t.SidetreeError(t.ErrorCode.CreateOperationTypeIncorrect);case 14:return u=n.delta,r.prev=15,r.next=18,M.parseDelta(n.delta);case 18:p=r.sent,r.next=23;break;case 21:r.prev=21,r.t0=r.catch(15);case 23:return d=e.computeDidUniqueSuffix(n.suffix_data),r.abrupt("return",new e(a,d,s,c,u,p));case 25:case"end":return r.stop()}}),r,null,[[15,21]])})));return function(e,t,n){return r.apply(this,arguments)}}(),e.parseSuffixData=function(){var e=y(S.mark((function e(r){var n,a,o,i;return S.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if("string"==typeof r){e.next=2;break}throw new t.SidetreeError(t.ErrorCode.CreateOperationSuffixDataMissingOrNotString);case 2:return n=t.Encoder.decodeAsString(r),e.next=5,D.parse(n);case 5:if(a=e.sent,2===Object.keys(a).length){e.next=9;break}throw new t.SidetreeError(t.ErrorCode.CreateOperationSuffixDataMissingOrUnknownProperty);case 9:return o=t.Encoder.decodeAsBuffer(a.delta_hash),i=t.Encoder.decodeAsBuffer(a.recovery_commitment),t.Multihash.verifyHashComputedUsingLatestSupportedAlgorithm(o),t.Multihash.verifyHashComputedUsingLatestSupportedAlgorithm(i),e.abrupt("return",{delta_hash:a.delta_hash,recovery_commitment:a.recovery_commitment});case 14:case"end":return e.stop()}}),e)})));return function(r){return e.apply(this,arguments)}}(),e}(),A=function(){function e(){}return e.generateEd25519KeyPair=function(){var e=y(S.mark((function e(){var r,t,n;return S.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,a.JWK.generate("OKP","Ed25519");case 2:return t=(r=e.sent).toJWK(!0),n=r.toJWK(!1),e.abrupt("return",[n,t]);case 6:case"end":return e.stop()}}),e)})));return function(){return e.apply(this,arguments)}}(),e.getBufferAtIndex=function(){var e=y(S.mark((function e(r,t){var n,a;return S.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,o.mnemonicToSeed(r);case 2:return n=s.fromMasterSeed(e.sent),a=n.derive("m/44'/60'/0'/0/"+t),e.abrupt("return",a.privateKey);case 7:case"end":return e.stop()}}),e)})));return function(r,t){return e.apply(this,arguments)}}(),e.generateEd25519KeyPairFromMnemonic=function(){var r=y(S.mark((function r(t,n){var a,o,s;return S.wrap((function(r){for(;;)switch(r.prev=r.next){case 0:return r.next=2,e.getBufferAtIndex(t,n);case 2:return a=r.sent,r.next=5,i.Ed25519KeyPair.generate({seed:a});case 5:return o=new i.Ed25519KeyPair(r.sent),r.next=9,o.toJwk(!1);case 9:return s=r.sent,r.next=12,o.toJwk(!0);case 12:return r.abrupt("return",[s,r.sent]);case 14:case"end":return r.stop()}}),r)})));return function(e,t){return r.apply(this,arguments)}}(),e.generateSecp256k1KeyPair=function(){var e=y(S.mark((function e(){var r,t,n;return S.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,a.JWK.generate("EC","secp256k1");case 2:return t=(r=e.sent).toJWK(!1),n=r.toJWK(!0),e.abrupt("return",[t,n]);case 6:case"end":return e.stop()}}),e)})));return function(){return e.apply(this,arguments)}}(),e.generateJwkKeyPairFromMnemonic=function(){var e=y(S.mark((function e(r,t,n){return S.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:e.t0=r,e.next="secp256k1"===e.t0?3:"ed25519"===e.t0?4:5;break;case 3:return e.abrupt("return",this.generateSecp256k1KeyPairFromMnemonic(t,n));case 4:return e.abrupt("return",this.generateEd25519KeyPairFromMnemonic(t,n));case 5:throw new Error("Invalid key type");case 6:case"end":return e.stop()}}),e,this)})));return function(r,t,n){return e.apply(this,arguments)}}(),e.generateSecp256k1KeyPairFromMnemonic=function(){var r=y(S.mark((function r(t,n){var a,o,i;return S.wrap((function(r){for(;;)switch(r.prev=r.next){case 0:return r.next=2,e.getBufferAtIndex(t,n);case 2:return(o=c.from(a=r.sent,"blk").toJwk("public")).crv="secp256k1",(i=c.from(a,"blk").toJwk("private")).crv="secp256k1",r.abrupt("return",[o,i]);case 8:case"end":return r.stop()}}),r)})));return function(e,t){return r.apply(this,arguments)}}(),e.validatePublicJwk=function(e){if(void 0===e)throw new t.SidetreeError(t.ErrorCode.JwkUndefined);var r=new Set(["kty","crv","x","y","kid"]);for(var n in e)if(!r.has(n))throw new t.SidetreeError(t.ErrorCode.JwkHasUnknownProperty);switch(e.crv){case"Ed25519":if("OKP"!==e.kty)throw new t.SidetreeError(t.ErrorCode.JwkMissingOrInvalidKty);if("string"!=typeof e.x)throw new t.SidetreeError(t.ErrorCode.JwkMissingOrInvalidTypeX);break;case"secp256k1":if("EC"!==e.kty)throw new t.SidetreeError(t.ErrorCode.JwkMissingOrInvalidKty);if("string"!=typeof e.x)throw new t.SidetreeError(t.ErrorCode.JwkMissingOrInvalidTypeX);if("string"!=typeof e.y)throw new t.SidetreeError(t.ErrorCode.JwkMissingOrInvalidTypeY);break;default:throw new t.SidetreeError(t.ErrorCode.JwkMissingOrInvalidCrv)}},e.getCurve25519PublicKey=function(e){var r=Object.assign({},e);return delete r.d,r},e}(),U=function(){function e(e){if("string"!=typeof e)throw new t.SidetreeError(t.ErrorCode.JwsCompactJwsNotString);var r=e.split(".");if(3!==r.length)throw new t.SidetreeError(t.ErrorCode.JwsCompactJwsInvalid);var n=r[0],a=r[1],o=r[2],i=t.Encoder.decodeBase64UrlAsString(n),s=JSON.parse(i);if(1!==Object.keys(s).length)throw new t.SidetreeError(t.ErrorCode.JwsProtectedHeaderMissingOrUnknownProperty);if("EdDSA"!==s.alg&&"ES256K"!==s.alg)throw new t.SidetreeError(t.ErrorCode.JwsProtectedHeaderMissingOrIncorrectAlg);if(!t.Encoder.isBase64UrlString(o))throw new t.SidetreeError(t.ErrorCode.JwsSignatureNotBase64UrlString);if(!t.Encoder.isBase64UrlString(a))throw new t.SidetreeError(t.ErrorCode.JwsPayloadNotBase64UrlString);this.protected=n,this.payload=a,this.signature=o}var r=e.prototype;return r.toCompactJws=function(){return e.createCompactJws(this.protected,this.payload,this.signature)},r.verifySignature=function(){var r=y(S.mark((function r(t){return S.wrap((function(r){for(;;)switch(r.prev=r.next){case 0:return r.abrupt("return",e.verifySignature(this.protected,this.payload,this.signature,t));case 1:case"end":return r.stop()}}),r,this)})));return function(e){return r.apply(this,arguments)}}(),e.verifySignature=function(){var r=y(S.mark((function r(t,n,a,o){var i;return S.wrap((function(r){for(;;)switch(r.prev=r.next){case 0:return i=t+"."+n+"."+a,r.next=3,e.verifyCompactJws(i,o);case 3:return r.abrupt("return",r.sent);case 5:case"end":return r.stop()}}),r)})));return function(e,t,n,a){return r.apply(this,arguments)}}(),e.verifyCompactJws=function(){var e=y(S.mark((function e(r,n){return S.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(e.prev=0,"Ed25519"!==n.crv){e.next=6;break}return e.next=4,i.EdDSA.verify(r,n);case 4:e.next=12;break;case 6:if("secp256k1"!==n.crv){e.next=11;break}return e.next=9,u.ES256K.verify(r,n);case 9:e.next=12;break;case 11:return e.abrupt("return",!1);case 12:return e.abrupt("return",!0);case 15:return e.prev=15,e.t0=e.catch(0),console.log("Input '"+r+"' failed signature verification: "+t.SidetreeError.createFromError(t.ErrorCode.JwsFailedSignatureValidation,e.t0)),e.abrupt("return",!1);case 19:case"end":return e.stop()}}),e,null,[[0,15]])})));return function(r,t){return e.apply(this,arguments)}}(),e.signAsCompactJws=function(){var e=y(S.mark((function e(r,t,n){var a;return S.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(a=w({},n,{alg:n&&n.alg?n.alg:"Ed25519"===t.crv?"EdDSA":"ES256K"}),"secp256k1"!==t.crv){e.next=6;break}return e.next=5,u.ES256K.sign(r,t,a);case 5:return e.abrupt("return",e.sent);case 6:return e.next=8,i.EdDSA.sign(r,t,a);case 8:return e.abrupt("return",e.sent);case 9:case"end":return e.stop()}}),e)})));return function(r,t,n){return e.apply(this,arguments)}}(),e.parseCompactJws=function(r){return new e(r)},e.createCompactJws=function(e,r,t){return e+"."+r+"."+t},e}(),_=function(){function e(e,r,n,a){this.operationBuffer=e,this.type=t.OperationType.Deactivate,this.didUniqueSuffix=r,this.signedDataJws=n,this.signedData=a}return e.parseOperationFromAnchorFile=function(){var r=y(S.mark((function r(t){var n;return S.wrap((function(r){for(;;)switch(r.prev=r.next){case 0:return n=Buffer.from(JSON.stringify(t)),r.next=3,e.parseObject(t,n,!0);case 3:return r.abrupt("return",r.sent);case 5:case"end":return r.stop()}}),r)})));return function(e){return r.apply(this,arguments)}}(),e.parse=function(){var r=y(S.mark((function r(t){var n,a;return S.wrap((function(r){for(;;)switch(r.prev=r.next){case 0:return n=t.toString(),r.next=3,D.parse(n);case 3:return a=r.sent,r.next=6,e.parseObject(a,t,!1);case 6:return r.abrupt("return",r.sent);case 8:case"end":return r.stop()}}),r)})));return function(e){return r.apply(this,arguments)}}(),e.parseObject=function(){var r=y(S.mark((function r(n,a,o){var i,s,c;return S.wrap((function(r){for(;;)switch(r.prev=r.next){case 0:if(i=3,o&&(i=2),Object.keys(n).length===i){r.next=5;break}throw new t.SidetreeError(t.ErrorCode.DeactivateOperationMissingOrUnknownProperty);case 5:if("string"==typeof n.did_suffix){r.next=7;break}throw new t.SidetreeError(t.ErrorCode.DeactivateOperationMissingOrInvalidDidUniqueSuffix);case 7:return s=U.parseCompactJws(n.signed_data),r.next=10,e.parseSignedDataPayload(s.payload,n.did_suffix);case 10:if(c=r.sent,o){r.next=14;break}if(n.type===t.OperationType.Deactivate){r.next=14;break}throw new t.SidetreeError(t.ErrorCode.DeactivateOperationTypeIncorrect);case 14:return r.abrupt("return",new e(a,n.did_suffix,s,c));case 15:case"end":return r.stop()}}),r)})));return function(e,t,n){return r.apply(this,arguments)}}(),e.parseSignedDataPayload=function(){var e=y(S.mark((function e(r,n){var a,o;return S.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return a=t.Encoder.decodeAsString(r),e.next=3,D.parse(a);case 3:if(o=e.sent,2===Object.keys(o).length){e.next=7;break}throw new t.SidetreeError(t.ErrorCode.DeactivateOperationSignedDataMissingOrUnknownProperty);case 7:if(o.did_suffix===n){e.next=9;break}throw new t.SidetreeError(t.ErrorCode.DeactivateOperationSignedDidUniqueSuffixMismatch);case 9:return A.validatePublicJwk(o.recovery_key),e.abrupt("return",{didSuffix:o.did_suffix,recovery_key:o.recovery_key});case 11:case"end":return e.stop()}}),e)})));return function(r,t){return e.apply(this,arguments)}}(),e}(),N=function(){function e(e,r,n,a,o,i){this.operationBuffer=e,this.type=t.OperationType.Recover,this.didUniqueSuffix=r,this.signedDataJws=n,this.signedData=a,this.encodedDelta=o,this.delta=i}return e.parseOperationFromAnchorFile=function(){var r=y(S.mark((function r(t){var n;return S.wrap((function(r){for(;;)switch(r.prev=r.next){case 0:return n=Buffer.from(JSON.stringify(t)),r.next=3,e.parseObject(t,n,!0);case 3:return r.abrupt("return",r.sent);case 5:case"end":return r.stop()}}),r)})));return function(e){return r.apply(this,arguments)}}(),e.parse=function(){var r=y(S.mark((function r(t){var n,a;return S.wrap((function(r){for(;;)switch(r.prev=r.next){case 0:return n=t.toString(),r.next=3,D.parse(n);case 3:return a=r.sent,r.next=6,e.parseObject(a,t,!1);case 6:return r.abrupt("return",r.sent);case 8:case"end":return r.stop()}}),r)})));return function(e){return r.apply(this,arguments)}}(),e.parseObject=function(){var r=y(S.mark((function r(n,a,o){var i,s,c,u,p;return S.wrap((function(r){for(;;)switch(r.prev=r.next){case 0:if(i=4,o&&(i=2),Object.keys(n).length===i){r.next=5;break}throw new t.SidetreeError(t.ErrorCode.RecoverOperationMissingOrUnknownProperty);case 5:if("string"==typeof n.did_suffix){r.next=7;break}throw new t.SidetreeError(t.ErrorCode.RecoverOperationMissingOrInvalidDidUniqueSuffix);case 7:return s=U.parseCompactJws(n.signed_data),r.next=10,e.parseSignedDataPayload(s.payload);case 10:if(c=r.sent,u=void 0,p=void 0,o){r.next=25;break}if(n.type===t.OperationType.Recover){r.next=16;break}throw new t.SidetreeError(t.ErrorCode.RecoverOperationTypeIncorrect);case 16:return u=n.delta,r.prev=17,r.next=20,M.parseDelta(n.delta);case 20:p=r.sent,r.next=25;break;case 23:r.prev=23,r.t0=r.catch(17);case 25:return r.abrupt("return",new e(a,n.did_suffix,s,c,u,p));case 26:case"end":return r.stop()}}),r,null,[[17,23]])})));return function(e,t,n){return r.apply(this,arguments)}}(),e.parseSignedDataPayload=function(){var e=y(S.mark((function e(r){var n,a,o,i;return S.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return n=t.Encoder.decodeAsString(r),e.next=3,D.parse(n);case 3:if(a=e.sent,3===Object.keys(a).length){e.next=7;break}throw new t.SidetreeError(t.ErrorCode.RecoverOperationSignedDataMissingOrUnknownProperty);case 7:return A.validatePublicJwk(a.recovery_key),o=t.Encoder.decodeAsBuffer(a.delta_hash),t.Multihash.verifyHashComputedUsingLatestSupportedAlgorithm(o),i=t.Encoder.decodeAsBuffer(a.recovery_commitment),t.Multihash.verifyHashComputedUsingLatestSupportedAlgorithm(i),e.abrupt("return",{delta_hash:a.delta_hash,recovery_key:a.recovery_key,recovery_commitment:a.recovery_commitment});case 13:case"end":return e.stop()}}),e)})));return function(r){return e.apply(this,arguments)}}(),e}(),B=function(){function e(e,r,t,n,a){this.model=e,this.didUniqueSuffixes=r,this.createOperations=t,this.recoverOperations=n,this.deactivateOperations=a}return e.parse=function(){var r=y(S.mark((function r(n){var a,o,i,s,c,u,p,d,f,h,l,v,m,y,w,x,b,k,O,C,T,M,A;return S.wrap((function(r){for(;;)switch(r.prev=r.next){case 0:return r.prev=0,r.next=3,P.decompress(n);case 3:a=r.sent,r.next=9;break;case 6:throw r.prev=6,r.t0=r.catch(0),t.SidetreeError.createFromError(t.ErrorCode.AnchorFileDecompressionFailure,r.t0);case 9:return r.prev=9,r.next=12,D.parse(a);case 12:o=r.sent,r.next=18;break;case 15:throw r.prev=15,r.t1=r.catch(9),t.SidetreeError.createFromError(t.ErrorCode.AnchorFileNotJson,r.t1);case 18:i=new Set(["map_file_uri","operations","writer_lock_id"]),r.t2=S.keys(o);case 20:if((r.t3=r.t2()).done){r.next=26;break}if(i.has(r.t3.value)){r.next=24;break}throw new t.SidetreeError(t.ErrorCode.AnchorFileHasUnknownProperty);case 24:r.next=20;break;case 26:if(Object.prototype.hasOwnProperty.call(o,"map_file_uri")){r.next=28;break}throw new t.SidetreeError(t.ErrorCode.AnchorFileMapFileHashMissing);case 28:if(Object.prototype.hasOwnProperty.call(o,"operations")){r.next=30;break}throw new t.SidetreeError(t.ErrorCode.AnchorFileMissingOperationsProperty);case 30:if(!Object.prototype.hasOwnProperty.call(o,"writer_lock_id")||"string"==typeof o.writer_lock_id){r.next=32;break}throw new t.SidetreeError(t.ErrorCode.AnchorFileWriterLockIPropertyNotString);case 32:if("string"==typeof o.map_file_uri){r.next=35;break}throw new t.SidetreeError(t.ErrorCode.AnchorFileMapFileHashNotString);case 35:s=new Set(["create","recover","deactivate"]),r.t4=S.keys(c=o.operations);case 38:if((r.t5=r.t4()).done){r.next=44;break}if(s.has(u=r.t5.value)){r.next=42;break}throw new t.SidetreeError(t.ErrorCode.AnchorFileUnexpectedPropertyInOperations,"Unexpected property "+u+" in 'operations' property in anchor file.");case 42:r.next=38;break;case 44:if(p=[],d=[],void 0===c.create){r.next=59;break}if(Array.isArray(c.create)){r.next=49;break}throw new t.SidetreeError(t.ErrorCode.AnchorFileCreatePropertyNotArray);case 49:f=g(c.create);case 50:if((h=f()).done){r.next=59;break}return l=h.value,r.next=54,F.parseOperationFromAnchorFile(l);case 54:d.push(v=r.sent),p.push(v.didUniqueSuffix);case 57:r.next=50;break;case 59:if(m=[],void 0===c.recover){r.next=73;break}if(Array.isArray(c.recover)){r.next=63;break}throw new t.SidetreeError(t.ErrorCode.AnchorFileRecoverPropertyNotArray);case 63:y=g(c.recover);case 64:if((w=y()).done){r.next=73;break}return x=w.value,r.next=68,N.parseOperationFromAnchorFile(x);case 68:m.push(b=r.sent),p.push(b.didUniqueSuffix);case 71:r.next=64;break;case 73:if(k=[],void 0===c.deactivate){r.next=87;break}if(Array.isArray(c.deactivate)){r.next=77;break}throw new t.SidetreeError(t.ErrorCode.AnchorFileDeactivatePropertyNotArray);case 77:O=g(c.deactivate);case 78:if((C=O()).done){r.next=87;break}return T=C.value,r.next=82,_.parseOperationFromAnchorFile(T);case 82:k.push(M=r.sent),p.push(M.didUniqueSuffix);case 85:r.next=78;break;case 87:if(!E.hasDuplicates(p)){r.next=89;break}throw new t.SidetreeError(t.ErrorCode.AnchorFileMultipleOperationsForTheSameDid);case 89:return A=new e(o,p,d,m,k),r.abrupt("return",A);case 91:case"end":return r.stop()}}),r,null,[[0,6],[9,15]])})));return function(e){return r.apply(this,arguments)}}(),e.createModel=function(){var e=y(S.mark((function e(r,t,n,a,o){var i,s,c;return S.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return i=n.map((function(e){return{suffix_data:e.encodedSuffixData}})),s=a.map((function(e){return{did_suffix:e.didUniqueSuffix,signed_data:e.signedDataJws.toCompactJws()}})),c=o.map((function(e){return{did_suffix:e.didUniqueSuffix,signed_data:e.signedDataJws.toCompactJws()}})),e.abrupt("return",{writer_lock_id:r,map_file_uri:t,operations:{create:i,recover:s,deactivate:c}});case 5:case"end":return e.stop()}}),e)})));return function(r,t,n,a,o){return e.apply(this,arguments)}}(),e.createBuffer=function(){var r=y(S.mark((function r(t,n,a,o,i){var s,c;return S.wrap((function(r){for(;;)switch(r.prev=r.next){case 0:return r.next=2,e.createModel(t,n,a,o,i);case 2:return s=JSON.stringify(r.sent),c=Buffer.from(s),r.abrupt("return",P.compress(c));case 6:case"end":return r.stop()}}),r)})));return function(e,t,n,a,o){return r.apply(this,arguments)}}(),e}(),q=function(){function e(e,r,t){this.versionManager=e,this.blockchain=r,this.batchingIntervalInSeconds=t,this.continuePeriodicBatchWriting=!1}var r=e.prototype;return r.startPeriodicBatchWriting=function(){var e=this;this.continuePeriodicBatchWriting=!0,setImmediate(y(S.mark((function r(){return S.wrap((function(r){for(;;)switch(r.prev=r.next){case 0:return r.abrupt("return",e.writeOperationBatch());case 1:case"end":return r.stop()}}),r)}))))},r.stopPeriodicBatchWriting=function(){console.info("Stopped periodic batch writing."),this.continuePeriodicBatchWriting=!1},r.writeOperationBatch=function(){var e=y(S.mark((function e(){var r,t,n=this;return S.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return r=p(),e.prev=1,console.info("Start operation batch writing..."),t=this.versionManager.getBatchWriter(this.blockchain.approximateTime.time),e.next=7,t.write();case 7:e.next=13;break;case 9:e.prev=9,e.t0=e.catch(1),console.error("Unexpected and unhandled error during batch writing, investigate and fix:"),console.error(e.t0);case 13:return e.prev=13,console.info("End batch writing. Duration: "+r.rounded()+" ms."),this.continuePeriodicBatchWriting&&(console.info("Waiting for "+this.batchingIntervalInSeconds+" seconds before writing another batch."),setTimeout(y(S.mark((function e(){return S.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",n.writeOperationBatch());case 1:case"end":return e.stop()}}),e)}))),1e3*this.batchingIntervalInSeconds)),e.finish(13);case 17:case"end":return e.stop()}}),e,this,[[1,9,13,17]])})));return function(){return e.apply(this,arguments)}}(),e}(),I=function(){function e(){}return e.parse=function(){var e=y(S.mark((function e(r){var n,a,o,i,s;return S.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return n=p(),e.next=3,P.decompress(r);case 3:return a=e.sent,e.next=6,D.parse(a);case 6:o=e.sent,console.info("Parsed chunk file in "+n.rounded()+" ms."),i=new Set(["deltas"]),e.t0=S.keys(o);case 10:if((e.t1=e.t0()).done){e.next=16;break}if(i.has(s=e.t1.value)){e.next=14;break}throw new t.SidetreeError(t.ErrorCode.ChunkFileUnexpectedProperty,"Unexpected property "+s+" in chunk file.");case 14:e.next=10;break;case 16:return this.validateDeltasProperty(o.deltas),e.abrupt("return",o);case 18:case"end":return e.stop()}}),e,this)})));return function(r){return e.apply(this,arguments)}}(),e.validateDeltasProperty=function(e){if(!(e instanceof Array))throw new t.SidetreeError(t.ErrorCode.ChunkFileDeltasPropertyNotArray,"Invalid chunk file, deltas property is not an array.");for(var r,n=g(e);!(r=n()).done;){var a=r.value;if("string"!=typeof a)throw new t.SidetreeError(t.ErrorCode.ChunkFileDeltasNotArrayOfStrings,"Invalid chunk file, deltas property is not an array of strings.");var o=Buffer.from(a);if(o.length>t.protocolParameters.maxDeltaSizeInBytes)throw new t.SidetreeError(t.ErrorCode.ChunkFileDeltaSizeExceedsLimit,"Operation size of "+o.length+" bytes exceeds the allowed limit of "+t.protocolParameters.maxDeltaSizeInBytes+" bytes.")}},e.createBuffer=function(){var e=y(S.mark((function e(r,t,n){var a,o;return S.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return(a=[]).push.apply(a,r.map((function(e){return e.encodedDelta}))),a.push.apply(a,t.map((function(e){return e.encodedDelta}))),a.push.apply(a,n.map((function(e){return e.encodedDelta}))),o=Buffer.from(JSON.stringify({deltas:a})),e.next=8,P.compress(Buffer.from(o));case 8:return e.abrupt("return",e.sent);case 10:case"end":return e.stop()}}),e)})));return function(r,t,n){return e.apply(this,arguments)}}(),e}(),R=function(){function e(e,r){this.maxConcurrentDownloads=e,this.cas=r,this.pendingDownloads=[],this.activeDownloads=new Map,this.completedDownloads=new Map,isNaN(e)&&(console.info("Maximum concurrent CAS download count not given, defaulting to 20."),this.maxConcurrentDownloads=20)}var r=e.prototype;return r.start=function(){var e=this;try{for(var r,t=[],n=g(this.activeDownloads);!(r=n()).done;){var a=r.value,o=a[0],i=a[1];i.completed&&(this.completedDownloads.set(o,i.fetchResult),t.push(o),i.resolve())}for(var s=0,c=t;s<c.length;s++)this.activeDownloads.delete(c[s]);var u=this.maxConcurrentDownloads-this.activeDownloads.size;if(u<=0)return;if(0===this.pendingDownloads.length)return;for(var p=0;p<this.pendingDownloads.length&&p<u;p++){var d=this.pendingDownloads[p];this.downloadAsync(d),this.activeDownloads.set(d.handle,d)}this.pendingDownloads.splice(0,u)}catch(e){console.error("Encountered unhandled/unexpected error in DownloadManager, must investigate and fix: "+e)}finally{setTimeout(y(S.mark((function r(){return S.wrap((function(r){for(;;)switch(r.prev=r.next){case 0:return r.abrupt("return",e.start());case 1:case"end":return r.stop()}}),r)}))),1e3)}},r.download=function(){var e=y(S.mark((function e(r,t){var n,a,o,i=this;return S.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return n=d.randomBytes(32),a=new Promise((function(e){i.pendingDownloads.push({handle:n,contentHash:r,maxSizeInBytes:t,resolve:e,completed:!1,content:void 0})})),e.next=4,a;case 4:return o=this.completedDownloads.get(n),this.completedDownloads.delete(n),e.abrupt("return",o);case 7:case"end":return e.stop()}}),e,this)})));return function(r,t){return e.apply(this,arguments)}}(),r.downloadAsync=function(){var e=y(S.mark((function e(r){var t;return S.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return t="",e.prev=1,t=r.contentHash,e.next=5,this.cas.read(t);case 5:r.fetchResult=e.sent,e.next=12;break;case 9:e.prev=9,e.t0=e.catch(1),console.error("Unexpected error while downloading '"+t+", investigate and fix "+e.t0+"'.");case 12:return e.prev=12,r.completed=!0,e.finish(12);case 15:case"end":return e.stop()}}),e,this,[[1,9,12,15]])})));return function(r){return e.apply(this,arguments)}}(),e}(),K=function(){function e(e,r,n,a,o,i){this.operationBuffer=e,this.type=t.OperationType.Update,this.didUniqueSuffix=r,this.signedDataJws=n,this.signedData=a,this.encodedDelta=o,this.delta=i}return e.parseOperationFromMapFile=function(){var r=y(S.mark((function r(t){var n;return S.wrap((function(r){for(;;)switch(r.prev=r.next){case 0:return n=Buffer.from(JSON.stringify(t)),r.next=3,e.parseObject(t,n,!0);case 3:return r.abrupt("return",r.sent);case 5:case"end":return r.stop()}}),r)})));return function(e){return r.apply(this,arguments)}}(),e.parse=function(){var r=y(S.mark((function r(t){var n,a;return S.wrap((function(r){for(;;)switch(r.prev=r.next){case 0:return n=t.toString(),r.next=3,D.parse(n);case 3:return a=r.sent,r.next=6,e.parseObject(a,t,!1);case 6:return r.abrupt("return",r.sent);case 8:case"end":return r.stop()}}),r)})));return function(e){return r.apply(this,arguments)}}(),e.parseObject=function(){var r=y(S.mark((function r(n,a,o){var i,s,c,u,p;return S.wrap((function(r){for(;;)switch(r.prev=r.next){case 0:if(i=4,o&&(i=2),Object.keys(n).length===i){r.next=5;break}throw new t.SidetreeError(t.ErrorCode.UpdateOperationMissingOrUnknownProperty);case 5:if("string"==typeof n.did_suffix){r.next=7;break}throw new t.SidetreeError(t.ErrorCode.UpdateOperationMissingDidUniqueSuffix);case 7:return s=U.parseCompactJws(n.signed_data),r.next=10,e.parseSignedDataPayload(s.payload);case 10:if(c=r.sent,u=void 0,p=void 0,o){r.next=20;break}if(n.type===t.OperationType.Update){r.next=16;break}throw new t.SidetreeError(t.ErrorCode.UpdateOperationTypeIncorrect);case 16:return u=n.delta,r.next=19,M.parseDelta(u);case 19:p=r.sent;case 20:return r.abrupt("return",new e(a,n.did_suffix,s,c,u,p));case 21:case"end":return r.stop()}}),r)})));return function(e,t,n){return r.apply(this,arguments)}}(),e.parseSignedDataPayload=function(){var e=y(S.mark((function e(r){var n,a,o;return S.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return n=t.Encoder.decodeAsString(r),e.next=3,D.parse(n);case 3:if(a=e.sent,2===Object.keys(a).length){e.next=7;break}throw new t.SidetreeError(t.ErrorCode.UpdateOperationSignedDataHasMissingOrUnknownProperty);case 7:return A.validatePublicJwk(a.update_key),o=t.Encoder.decodeAsBuffer(a.delta_hash),t.Multihash.verifyHashComputedUsingLatestSupportedAlgorithm(o),e.abrupt("return",{delta_hash:a.delta_hash,update_key:a.update_key});case 11:case"end":return e.stop()}}),e)})));return function(r){return e.apply(this,arguments)}}(),e}(),J=function(){function e(e,r,t){this.model=e,this.didUniqueSuffixes=r,this.updateOperations=t}return e.parse=function(){var r=y(S.mark((function r(n){var a,o,i,s,c,u;return S.wrap((function(r){for(;;)switch(r.prev=r.next){case 0:return r.prev=0,r.next=3,P.decompress(n);case 3:a=r.sent,r.next=9;break;case 6:throw r.prev=6,r.t0=r.catch(0),t.SidetreeError.createFromError(t.ErrorCode.MapFileDecompressionFailure,r.t0);case 9:return r.prev=9,r.next=12,D.parse(a);case 12:o=r.sent,r.next=18;break;case 15:throw r.prev=15,r.t1=r.catch(9),t.SidetreeError.createFromError(t.ErrorCode.MapFileNotJson,r.t1);case 18:i=new Set(["chunks","operations"]),r.t2=S.keys(o);case 20:if((r.t3=r.t2()).done){r.next=26;break}if(i.has(r.t3.value)){r.next=24;break}throw new t.SidetreeError(t.ErrorCode.MapFileHasUnknownProperty);case 24:r.next=20;break;case 26:return e.validateChunksProperty(o.chunks),r.next=29,e.parseOperationsProperty(o.operations);case 29:return c=(s=r.sent).map((function(e){return e.didUniqueSuffix})),u=new e(o,c,s),r.abrupt("return",u);case 33:case"end":return r.stop()}}),r,null,[[0,6],[9,15]])})));return function(e){return r.apply(this,arguments)}}(),e.parseOperationsProperty=function(){var e=y(S.mark((function e(r){var n,a,o,i,s;return S.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(void 0!==r){e.next=2;break}return e.abrupt("return",[]);case 2:if(1===Object.keys(r).length){e.next=5;break}throw new t.SidetreeError(t.ErrorCode.MapFileOperationsPropertyHasMissingOrUnknownProperty);case 5:if(n=[],Array.isArray(r.update)){e.next=8;break}throw new t.SidetreeError(t.ErrorCode.MapFileUpdateOperationsNotArray);case 8:a=g(r.update);case 9:if((o=a()).done){e.next=17;break}return i=o.value,e.next=13,K.parseOperationFromMapFile(i);case 13:n.push(e.sent);case 15:e.next=9;break;case 17:if(s=n.map((function(e){return e.didUniqueSuffix})),!E.hasDuplicates(s)){e.next=20;break}throw new t.SidetreeError(t.ErrorCode.MapFileMultipleOperationsForTheSameDid);case 20:return e.abrupt("return",n);case 21:case"end":return e.stop()}}),e)})));return function(r){return e.apply(this,arguments)}}(),e.validateChunksProperty=function(e){if(!Array.isArray(e))throw new t.SidetreeError(t.ErrorCode.MapFileChunksPropertyMissingOrIncorrectType);if(1!==e.length)throw new t.SidetreeError(t.ErrorCode.MapFileChunksPropertyDoesNotHaveExactlyOneElement);if(1!==Object.keys(e[0]).length)throw new t.SidetreeError(t.ErrorCode.MapFileChunkHasMissingOrUnknownProperty)},e.createBuffer=function(){var e=y(S.mark((function e(r,t){var n,a,o;return S.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return n=t.map((function(e){return{did_suffix:e.didUniqueSuffix,signed_data:e.signedDataJws.toCompactJws()}})),a={chunks:[{chunk_file_uri:r}]},n.length>0&&(a.operations={update:n}),o=JSON.stringify(a),e.next=6,P.compress(Buffer.from(o));case 6:return e.abrupt("return",e.sent);case 8:case"end":return e.stop()}}),e)})));return function(r,t){return e.apply(this,arguments)}}(),e}(),j=function(){function e(e){this.versionManager=e}return e.prototype.getQualifiedTransactions=function(){var e=y(S.mark((function e(r){var t,n,a,o,i,s,c,u,p,d;return S.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:for(t=void 0,n=[],a=g(r);!(o=a()).done;)(i=o.value).transactionTime!==t&&(n.push([]),t=i.transactionTime),n[n.length-1].push(i);s=[],c=0,u=n;case 5:if(!(c<u.length)){e.next=15;break}return d=this.versionManager.getTransactionSelector((p=u[c])[0].transactionTime),e.next=10,d.selectQualifiedTransactions(p);case 10:s.push.apply(s,e.sent);case 12:c++,e.next=5;break;case 15:return e.abrupt("return",s);case 16:case"end":return e.stop()}}),e,this)})));return function(r){return e.apply(this,arguments)}}(),e}(),L=function(){function e(e,r,t,n,a,o,i){this.versionManager=e,this.blockchain=r,this.maxConcurrentDownloads=t,this.operationStore=n,this.transactionStore=a,this.unresolvableTransactionStore=o,this.observingIntervalInSeconds=i,this.continuePeriodicProcessing=!1,this.transactionsUnderProcessing=[],this.throughputLimiter=new j(e)}var r=e.prototype;return r.refreshLastKnownTransaction=function(){var e=y(S.mark((function e(){return S.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.transactionStore.getLastTransaction();case 2:this.lastKnownTransaction=e.sent;case 3:case"end":return e.stop()}}),e,this)})));return function(){return e.apply(this,arguments)}}(),r.startPeriodicProcessing=function(){var e=y(S.mark((function e(){var r=this;return S.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.refreshLastKnownTransaction();case 2:console.info("Starting periodic transactions processing."),setImmediate(y(S.mark((function e(){return S.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:r.continuePeriodicProcessing=!0,r.processTransactions();case 2:case"end":return e.stop()}}),e)}))));case 4:case"end":return e.stop()}}),e,this)})));return function(){return e.apply(this,arguments)}}(),r.stopPeriodicProcessing=function(){console.info("Stopped periodic transactions processing."),this.continuePeriodicProcessing=!1},r.processTransactions=function(){var e=y(S.mark((function e(r){var n,a,o,i,s,c,u,d,f,h,l,v,m,w,x,b=this;return S.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return void 0===r&&(r=!1),e.prev=1,e.next=4,this.storeConsecutiveTransactionsProcessed();case 4:n=!1;case 5:return a=this.lastKnownTransaction?this.lastKnownTransaction.transactionNumber:void 0,o=this.lastKnownTransaction?this.lastKnownTransaction.transactionTimeHash:void 0,i=this.lastKnownTransaction?this.lastKnownTransaction.transactionTime:0,s=!1,c=void 0,u=p(),e.prev=11,console.info("Fetching Sidetree transactions from blockchain service..."),d=void 0!==a?a+1:void 0,e.next=16,this.blockchain.read(d,o);case 16:c=e.sent,console.info("Fetched "+c.transactions.length+" Sidetree transactions from blockchain service in "+u.rounded()+" ms."),e.next=28;break;case 20:if(e.prev=20,e.t0=e.catch(11),!(e.t0 instanceof t.SidetreeError&&e.t0.code===t.SharedErrorCode.InvalidTransactionNumberOrTimeHash)){e.next=27;break}console.info("Invalid transaction number "+a+" or time hash "+o+" given to blockchain service."),s=!0,e.next=28;break;case 27:throw e.t0;case 28:return f=c?c.transactions:[],n=!!c&&c.moreTransactions,e.next=32,this.throughputLimiter.getQualifiedTransactions(f);case 32:h=(h=e.sent).sort((function(e,r){return e.transactionNumber-r.transactionNumber})),l=g(h);case 35:if((v=l()).done){e.next=47;break}if(this.transactionsUnderProcessing.push(w={transaction:m=v.value,processingStatus:t.TransactionProcessingStatus.Pending}),!r){e.next=44;break}return e.next=42,this.processTransaction(m,w);case 42:e.next=45;break;case 44:this.processTransaction(m,w);case 45:e.next=35;break;case 47:if(x=!1,s&&(i<=this.blockchain.approximateTime.time?(x=!0,n=!0):console.info("Blockchain microservice blockchain time is behind last known transaction time, waiting for blockchain microservice to catch up...")),!x){e.next=59;break}return console.info("Block reorganization detected."),e.next=53,this.waitUntilCountOfTransactionsUnderProcessingIsLessOrEqualTo(0);case 53:return console.info("Reverting invalid transactions..."),e.next=56,this.revertInvalidTransactions();case 56:console.info("Completed reverting invalid transactions."),e.next=61;break;case 59:return e.next=61,this.waitUntilCountOfTransactionsUnderProcessingIsLessOrEqualTo(this.maxConcurrentDownloads);case 61:f&&f.length>0&&(this.lastKnownTransaction=f[f.length-1]);case 62:if(n){e.next=5;break}case 63:return e.next=65,this.storeConsecutiveTransactionsProcessed();case 65:return console.info("Successfully kicked off downloading/processing of all new Sidetree transactions."),e.next=68,this.processUnresolvableTransactions(r);case 68:e.next=74;break;case 70:e.prev=70,e.t1=e.catch(1),console.error("Encountered unhandled and possibly fatal Observer error, must investigate and fix:"),console.error(e.t1);case 74:return e.prev=74,this.continuePeriodicProcessing&&(console.info("Waiting for "+this.observingIntervalInSeconds+" seconds before fetching and processing transactions again."),setTimeout(y(S.mark((function e(){return S.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",b.processTransactions());case 1:case"end":return e.stop()}}),e)}))),1e3*this.observingIntervalInSeconds)),e.finish(74);case 77:case"end":return e.stop()}}),e,this,[[1,70,74,77],[11,20]])})));return function(r){return e.apply(this,arguments)}}(),r.waitUntilCountOfTransactionsUnderProcessingIsLessOrEqualTo=function(){var e=y(S.mark((function e(r){return S.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(!(this.transactionsUnderProcessing.length>r)){e.next=7;break}return e.next=3,this.storeConsecutiveTransactionsProcessed();case 3:return e.next=5,new Promise((function(e){return setTimeout(e,1e3)}));case 5:e.next=0;break;case 7:return e.abrupt("return");case 8:case"end":return e.stop()}}),e,this)})));return function(r){return e.apply(this,arguments)}}(),r.processUnresolvableTransactions=function(){var e=y(S.mark((function e(r){var n,a,o,i,s,c,u,d;return S.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return void 0===r&&(r=!1),n=p(),e.next=4,this.unresolvableTransactionStore.getUnresolvableTransactionsDueForRetry();case 4:a=e.sent,console.info("Fetched "+a.length+" unresolvable transactions to retry in "+n.rounded()+" ms."),o=[],i=g(a);case 8:if((s=i()).done){e.next=20;break}if(o.push(u={transaction:c=s.value,processingStatus:t.TransactionProcessingStatus.Pending}),!r){e.next=17;break}return e.next=15,this.processTransaction(c,u);case 15:e.next=18;break;case 17:this.processTransaction(c,u);case 18:e.next=8;break;case 20:if(!(o.length>0)){e.next=28;break}for(d=0;d<o.length&&o[d].processingStatus===t.TransactionProcessingStatus.Processed;)d++;return o.splice(0,d),e.next=26,new Promise((function(e){return setTimeout(e,1e3)}));case 26:e.next=20;break;case 28:case"end":return e.stop()}}),e,this)})));return function(r){return e.apply(this,arguments)}}(),r.storeConsecutiveTransactionsProcessed=function(){var e=y(S.mark((function e(){var r;return S.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:r=0;case 1:if(!(r<this.transactionsUnderProcessing.length&&this.transactionsUnderProcessing[r].processingStatus===t.TransactionProcessingStatus.Processed)){e.next=7;break}return e.next=4,this.transactionStore.addTransaction(this.transactionsUnderProcessing[r].transaction);case 4:r++,e.next=1;break;case 7:this.transactionsUnderProcessing.splice(0,r);case 8:case"end":return e.stop()}}),e,this)})));return function(){return e.apply(this,arguments)}}(),r.processTransaction=function(){var e=y(S.mark((function e(r,n){var a,o;return S.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,o=this.versionManager.getTransactionProcessor(r.transactionTime),e.next=4,o.processTransaction(r);case 4:a=e.sent,e.next=12;break;case 7:e.prev=7,e.t0=e.catch(0),console.error("Unhandled error encountered processing transaction '"+r.transactionNumber+"'."),console.error(e.t0),a=!1;case 12:if(e.prev=12,console.info("Finished processing transaction '"+r.transactionNumber+"'."),n.processingStatus=t.TransactionProcessingStatus.Processed,!a){e.next=21;break}return console.info("Removing transaction '"+r.transactionNumber+"' from unresolvable transactions if exists..."),e.next=19,this.unresolvableTransactionStore.removeUnresolvableTransaction(r);case 19:e.next=24;break;case 21:return console.info("Recording failed processing attempt for transaction '"+r.transactionNumber+"'..."),e.next=24,this.unresolvableTransactionStore.recordUnresolvableTransactionFetchAttempt(r);case 24:return e.finish(12);case 25:case"end":return e.stop()}}),e,this,[[0,7,12,25]])})));return function(r,t){return e.apply(this,arguments)}}(),r.revertInvalidTransactions=function(){var e=y(S.mark((function e(){var r,t,n;return S.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.transactionStore.getExponentiallySpacedTransactions();case 2:return r=e.sent,e.next=5,this.blockchain.getFirstValidTransaction(r);case 5:return n=void 0===(t=e.sent)?void 0:t.transactionNumber,console.info("Best known valid recent transaction: "+n),console.info("Reverting operations..."),e.next=11,this.operationStore.delete(n);case 11:return e.next=13,this.transactionStore.removeTransactionsLaterThan(n);case 13:return e.next=15,this.unresolvableTransactionStore.removeUnresolvableTransactionsLaterThan(n);case 15:this.lastKnownTransaction=t;case 16:case"end":return e.stop()}}),e,this)})));return function(){return e.apply(this,arguments)}}(),e}(),V=function(){function e(){}return e.parse=function(){var e=y(S.mark((function e(r){var n,a,o,i;return S.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(n=r.toString(),a=JSON.parse(n),i=!1,(o=a.type)!==t.OperationType.Create){e.next=8;break}return e.abrupt("return",F.parseObject(a,r,i));case 8:if(o!==t.OperationType.Update){e.next=12;break}return e.abrupt("return",K.parseObject(a,r,i));case 12:if(o!==t.OperationType.Recover){e.next=16;break}return e.abrupt("return",N.parseObject(a,r,i));case 16:if(o!==t.OperationType.Deactivate){e.next=20;break}return e.abrupt("return",_.parseObject(a,r,i));case 20:throw new t.SidetreeError(t.ErrorCode.OperationTypeUnknownOrMissing);case 21:case"end":return e.stop()}}),e)})));return function(r){return e.apply(this,arguments)}}(),e}();V.maxEncodedRevealValueLength=50;var H=function(){function e(){}return e.generateRandomHash=function(){var e=d.randomBytes(32);return t.Encoder.encode(t.Multihash.hash(e))},e.generateKeyPair=function(){var e=y(S.mark((function e(r,n){var a,o,i;return S.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,A.generateEd25519KeyPair();case 2:return o=(a=e.sent)[1],i={id:r,type:"Ed25519VerificationKey2018",jwk:a[0],purpose:n||Object.values(t.PublicKeyPurpose)},e.abrupt("return",[i,o]);case 7:case"end":return e.stop()}}),e)})));return function(r,t){return e.apply(this,arguments)}}(),e.generateAnchoredCreateOperation=function(){var r=y(S.mark((function r(n){var a;return S.wrap((function(r){for(;;)switch(r.prev=r.next){case 0:return r.next=2,e.generateCreateOperation();case 2:return r.abrupt("return",{createOperation:(a=r.sent).createOperation,operationRequest:a.operationRequest,anchoredOperationModel:{type:t.OperationType.Create,didUniqueSuffix:a.createOperation.didUniqueSuffix,operationBuffer:a.createOperation.operationBuffer,transactionNumber:n.transactionNumber,transactionTime:n.transactionTime,operationIndex:n.operationIndex},recoveryPublicKey:a.recoveryPublicKey,recoveryPrivateKey:a.recoveryPrivateKey,updatePublicKey:a.updatePublicKey,updatePrivateKey:a.updatePrivateKey,signingPublicKey:a.signingPublicKey,signingPrivateKey:a.signingPrivateKey,nextUpdateRevealValueEncodedString:a.nextUpdateRevealValueEncodedString});case 5:case"end":return r.stop()}}),r)})));return function(e){return r.apply(this,arguments)}}(),e.generateCreateOperation=function(){var r=y(S.mark((function r(){var n,a,o,i,s,c,u,p,d,f,h,l,v,m,y;return S.wrap((function(r){for(;;)switch(r.prev=r.next){case 0:return n="signingKey",r.next=3,A.generateEd25519KeyPair();case 3:return o=(a=r.sent)[0],i=a[1],r.next=8,A.generateEd25519KeyPair();case 8:return c=(s=r.sent)[0],u=s[1],r.next=13,e.generateKeyPair(n);case 13:return d=(p=r.sent)[0],f=p[1],h=e.generateServiceEndpoints(["serviceEndpointId123"]),r.next=19,e.generateCreateOperationRequest(o,c,[d],h);case 19:return l=r.sent,v=Buffer.from(JSON.stringify(l)),r.next=23,F.parse(v);case 23:return m=r.sent,y=t.Multihash.canonicalizeThenHashThenEncode(d.jwk),r.abrupt("return",{createOperation:m,operationRequest:l,recoveryPublicKey:o,recoveryPrivateKey:i,updatePublicKey:c,updatePrivateKey:u,signingPublicKey:d,signingPrivateKey:f,nextUpdateRevealValueEncodedString:y});case 26:case"end":return r.stop()}}),r)})));return function(){return r.apply(this,arguments)}}(),e.generateRecoverOperation=function(){var r=y(S.mark((function r(t){var n,a,o,i,s,c,u,p,d,f,h,l,v;return S.wrap((function(r){for(;;)switch(r.prev=r.next){case 0:return n="newSigningKey",r.next=3,A.generateEd25519KeyPair();case 3:return o=(a=r.sent)[0],i=a[1],r.next=8,e.generateKeyPair(n);case 8:return c=(s=r.sent)[0],u=s[1],r.next=13,e.generateKeyPair("newKey");case 13:return p=r.sent[0],d=e.generateServiceEndpoints(["serviceEndpointId123"]),r.next=18,e.generateKeyPair("update_key");case 18:return h=(f=r.sent)[0],l=f[1],r.next=23,e.generateRecoverOperationRequest(t.didUniqueSuffix,t.recoveryPrivateKey,o,c,d,[p]);case 23:return v=Buffer.from(JSON.stringify(r.sent)),r.next=27,N.parse(v);case 27:return r.abrupt("return",{recoverOperation:r.sent,operationBuffer:v,recoveryPublicKey:o,recoveryPrivateKey:i,signingPublicKey:c,signingPrivateKey:u,update_key:h,updatePrivateKey:l});case 29:case"end":return r.stop()}}),r)})));return function(e){return r.apply(this,arguments)}}(),e.generateUpdateOperation=function(){var r=y(S.mark((function r(n,a,o){var i,s,c,u,p;return S.wrap((function(r){for(;;)switch(r.prev=r.next){case 0:return i="additional-key",r.next=3,e.generateKeyPair(i);case 3:return c=(s=r.sent)[0],u=s[1],r.next=8,e.createUpdateOperationRequestForAddingAKey(n,a,o,c,t.Multihash.canonicalizeThenHashThenEncode(c));case 8:return p=Buffer.from(JSON.stringify(r.sent)),r.next=12,K.parse(p);case 12:return r.abrupt("return",{updateOperation:r.sent,operationBuffer:p,additionalKeyId:i,additionalPublicKey:c,additionalPrivateKey:u,nextUpdateKey:c.jwk});case 14:case"end":return r.stop()}}),r)})));return function(e,t,n){return r.apply(this,arguments)}}(),e.createAnchoredOperationModelFromOperationModel=function(e,r,t,n){return{didUniqueSuffix:e.didUniqueSuffix,type:e.type,operationBuffer:e.operationBuffer,operationIndex:n,transactionNumber:t,transactionTime:r}},e.generateCreateOperationRequest=function(){var e=y(S.mark((function e(r,n,a,o){var i,s,c,u,p,d,f;return S.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return i=[{action:"replace",document:{public_keys:a,service_endpoints:o}}],s={update_commitment:t.Multihash.canonicalizeThenHashThenEncode(n),patches:i},c=Buffer.from(JSON.stringify(s)),u=t.Encoder.encode(t.Multihash.hash(c)),p={delta_hash:u,recovery_commitment:t.Multihash.canonicalizeThenHashThenEncode(r)},d=t.Encoder.encode(JSON.stringify(p)),f=t.Encoder.encode(c),e.abrupt("return",{type:t.OperationType.Create,suffix_data:d,delta:f});case 10:case"end":return e.stop()}}),e)})));return function(r,t,n,a){return e.apply(this,arguments)}}(),e.generateUpdateOperationRequest=function(){var r=y(S.mark((function r(n){var a,o,i,s,c,u,p;return S.wrap((function(r){for(;;)switch(r.prev=r.next){case 0:return void 0===n&&(n=e.generateRandomHash()),r.next=3,e.generateKeyPair("nextUpdateKey");case 3:return a=t.Multihash.canonicalizeThenHashThenEncode(r.sent[0].jwk),r.next=9,e.generateKeyPair("anyNewKey");case 9:return o=[{action:"add-public-keys",public_keys:[r.sent[0]]}],r.next=15,e.generateKeyPair("anySigningKeyId");case 15:return s=(i=r.sent)[0],c=i[1],r.next=20,e.createUpdateOperationRequest(n,s.jwk,c,a,o);case 20:return u=r.sent,p=Buffer.from(JSON.stringify(u)),r.next=24,K.parse(p);case 24:return r.abrupt("return",{request:u,buffer:p,updateOperation:r.sent});case 26:case"end":return r.stop()}}),r)})));return function(e){return r.apply(this,arguments)}}(),e.createUpdateOperationRequest=function(){var r=y(S.mark((function r(n,a,o,i,s){var c,u,p,d;return S.wrap((function(r){for(;;)switch(r.prev=r.next){case 0:return c=JSON.stringify({patches:s,update_commitment:i}),u=t.Encoder.encode(t.Multihash.hash(Buffer.from(c))),p=t.Encoder.encode(c),d={update_key:a,delta_hash:u},r.next=7,e.signUsingEd25519(d,o);case 7:return r.abrupt("return",{type:t.OperationType.Update,did_suffix:n,delta:p,signed_data:r.sent});case 10:case"end":return r.stop()}}),r)})));return function(e,t,n,a,o){return r.apply(this,arguments)}}(),e.generateRecoverOperationRequest=function(){var r=y(S.mark((function r(n,a,o,i,s,c){var u;return S.wrap((function(r){for(;;)switch(r.prev=r.next){case 0:return u={public_keys:c,service_endpoints:s},r.next=3,e.createRecoverOperationRequest(n,a,o,t.Multihash.canonicalizeThenHashThenEncode(i.jwk),u);case 3:return r.abrupt("return",r.sent);case 5:case"end":return r.stop()}}),r)})));return function(e,t,n,a,o,i){return r.apply(this,arguments)}}(),e.createRecoverOperationRequest=function(){var r=y(S.mark((function r(n,a,o,i,s){var c,u,p,d,f;return S.wrap((function(r){for(;;)switch(r.prev=r.next){case 0:return c=Buffer.from(JSON.stringify({patches:[{action:"replace",document:s}],update_commitment:i})),u=t.Encoder.encode(t.Multihash.hash(c)),p={delta_hash:u,recovery_key:A.getCurve25519PublicKey(a),recovery_commitment:t.Multihash.canonicalizeThenHashThenEncode(o)},r.next=7,e.signUsingEd25519(p,a);case 7:return d=r.sent,f=t.Encoder.encode(c),r.abrupt("return",{type:t.OperationType.Recover,did_suffix:n,signed_data:d,delta:f});case 11:case"end":return r.stop()}}),r)})));return function(e,t,n,a,o){return r.apply(this,arguments)}}(),e.createDeactivateOperationRequest=function(){var r=y(S.mark((function r(n,a){var o;return S.wrap((function(r){for(;;)switch(r.prev=r.next){case 0:return o={did_suffix:n,recovery_key:A.getCurve25519PublicKey(a)},r.next=3,e.signUsingEd25519(o,a);case 3:return r.abrupt("return",{type:t.OperationType.Deactivate,did_suffix:n,signed_data:r.sent});case 6:case"end":return r.stop()}}),r)})));return function(e,t){return r.apply(this,arguments)}}(),e.generateCreateOperationBuffer=function(){var r=y(S.mark((function r(t,n,a){return S.wrap((function(r){for(;;)switch(r.prev=r.next){case 0:return r.next=2,e.generateCreateOperationRequest(t,n.jwk,[n],a);case 2:return r.abrupt("return",Buffer.from(JSON.stringify(r.sent)));case 4:case"end":return r.stop()}}),r)})));return function(e,t,n){return r.apply(this,arguments)}}(),e.createUpdateOperationRequestForAddingAKey=function(){var r=y(S.mark((function r(t,n,a,o,i){var s;return S.wrap((function(r){for(;;)switch(r.prev=r.next){case 0:return s=[{action:"add-public-keys",public_keys:[o]}],r.next=3,e.createUpdateOperationRequest(t,n,a,i,s);case 3:return r.abrupt("return",r.sent);case 5:case"end":return r.stop()}}),r)})));return function(e,t,n,a,o){return r.apply(this,arguments)}}(),e.createUpdateOperationRequestForHubEndpoints=function(){var r=y(S.mark((function r(t,n,a,o,i,s){var c,u;return S.wrap((function(r){for(;;)switch(r.prev=r.next){case 0:return c=[],void 0!==i&&(u={action:"add-service-endpoints",service_endpoints:e.generateServiceEndpoints([i])},c.push(u)),s.length>0&&c.push({action:"remove-service-endpoints",ids:s}),r.next=5,e.createUpdateOperationRequest(t,n,a,o,c);case 5:return r.abrupt("return",r.sent);case 7:case"end":return r.stop()}}),r)})));return function(e,t,n,a,o,i){return r.apply(this,arguments)}}(),e.signUsingEd25519=function(){var e=y(S.mark((function e(r,t){var n;return S.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return n={alg:"EdDSA"},e.next=3,U.signAsCompactJws(r,t,n);case 3:return e.abrupt("return",e.sent);case 5:case"end":return e.stop()}}),e)})));return function(r,t){return e.apply(this,arguments)}}(),e.createDeactivateOperation=function(){var r=y(S.mark((function r(t,n){var a,o;return S.wrap((function(r){for(;;)switch(r.prev=r.next){case 0:return r.next=2,e.createDeactivateOperationRequest(t,n);case 2:return a=r.sent,o=Buffer.from(JSON.stringify(a)),r.next=6,_.parse(o);case 6:return r.abrupt("return",{operationRequest:a,operationBuffer:o,deactivateOperation:r.sent});case 8:case"end":return r.stop()}}),r)})));return function(e,t){return r.apply(this,arguments)}}(),e.generateServiceEndpoints=function(e){for(var r,t=[],n=g(e);!(r=n()).done;)t.push({id:r.value,type:"someType",endpoint:"https://www.url.com"});return t},e}(),z=function(){function e(e,r){this.versionManager=e,this.operationStore=r}var r=e.prototype;return r.resolve=function(){var r=y(S.mark((function r(t){var n,a,o,i,s;return S.wrap((function(r){for(;;)switch(r.prev=r.next){case 0:return console.info("Resolving DID unique suffix '"+t+"'..."),r.next=3,this.operationStore.get(t);case 3:return n=e.categorizeOperationsByType(r.sent),r.next=7,this.applyCreateOperation(n.createOperations);case 7:if(void 0!==(a=r.sent)){r.next=10;break}return r.abrupt("return",void 0);case 10:return o=n.recoverOperations.concat(n.deactivateOperations),r.next=13,this.constructCommitValueToOperationLookupMap(o);case 13:return i=r.sent,r.next=16,this.applyRecoverAndDeactivateOperations(a,i);case 16:if(void 0!==(a=r.sent).nextRecoveryCommitmentHash){r.next=19;break}return r.abrupt("return",a);case 19:return r.next=21,this.constructCommitValueToOperationLookupMap(n.updateOperations);case 21:return s=r.sent,r.next=24,this.applyUpdateOperations(a,s);case 24:return r.abrupt("return",a=r.sent);case 26:case"end":return r.stop()}}),r,this)})));return function(e){return r.apply(this,arguments)}}(),e.categorizeOperationsByType=function(e){for(var r,n=[],a=[],o=[],i=[],s=g(e);!(r=s()).done;){var c=r.value;c.type===t.OperationType.Create?n.push(c):c.type===t.OperationType.Recover?a.push(c):c.type===t.OperationType.Update?o.push(c):i.push(c)}return{createOperations:n,recoverOperations:a,updateOperations:o,deactivateOperations:i}},r.applyCreateOperation=function(){var e=y(S.mark((function e(r){var t,n,a,o;return S.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:n=g(r);case 1:if((a=n()).done){e.next=10;break}return o=a.value,e.next=5,this.applyOperation(o,void 0);case 5:if(void 0===(t=e.sent)){e.next=8;break}return e.abrupt("break",10);case 8:e.next=1;break;case 10:return e.abrupt("return",t);case 11:case"end":return e.stop()}}),e,this)})));return function(r){return e.apply(this,arguments)}}(),r.applyRecoverAndDeactivateOperations=function(){var e=y(S.mark((function e(r,t){var n,a,o;return S.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:n=r;case 1:if(!t.has(n.nextRecoveryCommitmentHash)){e.next=14;break}return a=(a=t.get(n.nextRecoveryCommitmentHash)).sort((function(e,r){return e.transactionNumber-r.transactionNumber})),e.next=6,this.applyFirstValidOperation(a,n);case 6:if(void 0!==(o=e.sent)){e.next=9;break}return e.abrupt("break",14);case 9:if(void 0!==(n=o).nextRecoveryCommitmentHash){e.next=12;break}return e.abrupt("return",n);case 12:e.next=1;break;case 14:return e.abrupt("return",n);case 15:case"end":return e.stop()}}),e,this)})));return function(r,t){return e.apply(this,arguments)}}(),r.applyUpdateOperations=function(){var e=y(S.mark((function e(r,t){var n,a,o;return S.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:n=r;case 1:if(!t.has(n.nextUpdateCommitmentHash)){e.next=12;break}return a=(a=t.get(n.nextUpdateCommitmentHash)).sort((function(e,r){return e.transactionNumber-r.transactionNumber})),e.next=6,this.applyFirstValidOperation(a,n);case 6:if(void 0!==(o=e.sent)){e.next=9;break}return e.abrupt("break",12);case 9:n=o,e.next=1;break;case 12:return e.abrupt("return",n);case 13:case"end":return e.stop()}}),e,this)})));return function(r,t){return e.apply(this,arguments)}}(),r.applyOperation=function(){var e=y(S.mark((function e(r,n){var a,o;return S.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return a=n,e.prev=1,o=this.versionManager.getOperationProcessor(r.transactionTime),e.next=5,o.apply(r,a);case 5:a=e.sent,e.next=11;break;case 8:e.prev=8,e.t0=e.catch(1),console.log("Skipped bad operation for DID "+r.didUniqueSuffix+" at time "+r.transactionTime+". Error: "+t.SidetreeError.stringify(e.t0));case 11:return e.abrupt("return",a);case 12:case"end":return e.stop()}}),e,this,[[1,8]])})));return function(r,t){return e.apply(this,arguments)}}(),r.applyFirstValidOperation=function(){var e=y(S.mark((function e(r,t){var n,a,o,i;return S.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:n=t,a=g(r);case 2:if((o=a()).done){e.next=11;break}return i=o.value,e.next=6,this.applyOperation(i,n);case 6:if((n=e.sent).lastOperationTransactionNumber===t.lastOperationTransactionNumber){e.next=9;break}return e.abrupt("return",n);case 9:e.next=2;break;case 11:return e.abrupt("return",void 0);case 12:case"end":return e.stop()}}),e,this)})));return function(r,t){return e.apply(this,arguments)}}(),r.constructCommitValueToOperationLookupMap=function(){var e=y(S.mark((function e(r){var n,a,o,i,s,c,u,p,d;return S.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:n=new Map,a=g(this.versionManager.allSupportedHashAlgorithms);case 3:if((o=a()).done){e.next=18;break}i=o.value,s=g(r);case 6:if((c=s()).done){e.next=16;break}return p=this.versionManager.getOperationProcessor((u=c.value).transactionTime),e.next=11,p.getRevealValue(u);case 11:d=t.Multihash.hashThenEncode(e.sent,i),n.has(d)?n.get(d).push(u):n.set(d,[u]);case 14:e.next=6;break;case 16:e.next=3;break;case 18:return e.abrupt("return",n);case 19:case"end":return e.stop()}}),e,this)})));return function(r){return e.apply(this,arguments)}}(),e}(),W=function(){function e(e){this.serviceName=e}return e.prototype.getServiceVersion=function(){return{name:this.serviceName,version:e.packageJson.version}},e}();W.packageJson=require("../package.json");var Q=function(){function e(){}return e.computeMinimumTransactionFee=function(e,r){if(r<=0)throw new t.SidetreeError(t.ErrorCode.OperationCountLessThanZero,"Fee cannot be calculated for the given number of operations: "+r);return Math.max(e*t.protocolParameters.normalizedFeeToPerOperationFeeMultiplier*r,e)},e.verifyTransactionFeeAndThrowOnError=function(e,r,n){if(r<=0)throw new t.SidetreeError(t.ErrorCode.OperationCountLessThanZero,"The number of operations: "+r+" must be greater than 0");if(e<n)throw new t.SidetreeError(t.ErrorCode.TransactionFeePaidLessThanNormalizedFee,"The actual fee paid: "+e+" should be greater than or equal to the normalized fee: "+n);var a=n*t.protocolParameters.normalizedFeeToPerOperationFeeMultiplier;if(e/r<a)throw new t.SidetreeError(t.ErrorCode.TransactionFeePaidInvalid,"The actual fee paid: "+e+" per number of operations: "+r+" should be at least "+a+".")},e}(),G=function(){function e(){}return e.calculateMaxNumberOfOperationsAllowed=function(e,r){if(void 0===e)return t.protocolParameters.maxNumberOfOperationsForNoValueTimeLock;var n=r.getVersionMetadata(e.lockTransactionTime),a=Math.floor(e.amountLocked/(e.normalizedFee*n.normalizedFeeToPerOperationFeeMultiplier*n.valueTimeLockAmountMultiplier));return Math.max(a,t.protocolParameters.maxNumberOfOperationsForNoValueTimeLock)},e.verifyLockAmountAndThrowOnError=function(e,r,n,a,o){if(!(r<=t.protocolParameters.maxNumberOfOperationsForNoValueTimeLock)){if(e){if(e.owner!==a)throw new t.SidetreeError(t.ErrorCode.ValueTimeLockVerifierTransactionWriterLockOwnerMismatch,"Sidetree transaction writer: "+a+" - Lock owner: "+e.owner);if(n<e.lockTransactionTime||n>=e.unlockTransactionTime)throw new t.SidetreeError(t.ErrorCode.ValueTimeLockVerifierTransactionTimeOutsideLockRange,"Sidetree transaction block: "+n+"; lock start time: "+e.lockTransactionTime+"; unlock time: "+e.unlockTransactionTime)}var i=this.calculateMaxNumberOfOperationsAllowed(e,o);if(r>i)throw new t.SidetreeError(t.ErrorCode.ValueTimeLockVerifierInvalidNumberOfOperations,"Max number of ops allowed: "+i+"; actual number of ops: "+r)}},e}(),Y=function(){function e(e,r,t,n){this.downloadManager=e,this.operationStore=r,this.blockchain=t,this.versionMetadataFetcher=n}var r=e.prototype;return r.processTransaction=function(){var e=y(S.mark((function e(r){var n,a,o,i,s;return S.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,n=t.AnchoredDataSerializer.deserialize(r.anchorString),Q.verifyTransactionFeeAndThrowOnError(r.transactionFeePaid,n.numberOfOperations,r.normalizedTransactionFee),e.next=5,this.downloadAndVerifyAnchorFile(r,n.anchorFileHash,n.numberOfOperations);case 5:return a=e.sent,e.next=8,this.downloadAndVerifyMapFile(a,n.numberOfOperations);case 8:return o=e.sent,e.next=11,this.downloadAndVerifyChunkFile(o);case 11:return i=e.sent,e.next=14,this.composeAnchoredOperationModels(r,a,o,i);case 14:return s=e.sent,e.next=17,this.operationStore.put(s);case 17:return e.abrupt("return",!0);case 20:if(e.prev=20,e.t0=e.catch(0),!(e.t0 instanceof t.SidetreeError)){e.next=29;break}if(e.t0.code!==t.ErrorCode.CasNotReachable&&e.t0.code!==t.ErrorCode.CasFileNotFound){e.next=25;break}return e.abrupt("return",!1);case 25:return console.info("Ignoring error: "+e.t0.message),e.abrupt("return",!0);case 29:return console.error("Unexpected error processing transaction, MUST investigate and fix: "+e.t0.message),e.abrupt("return",!1);case 31:case"end":return e.stop()}}),e,this,[[0,20]])})));return function(r){return e.apply(this,arguments)}}(),r.downloadAndVerifyAnchorFile=function(){var e=y(S.mark((function e(r,n,a){var o,i,s;return S.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(!(a>t.protocolParameters.maxOperationsPerBatch)){e.next=2;break}throw new t.SidetreeError(t.ErrorCode.TransactionProcessorPaidOperationCountExceedsLimit,"Paid batch size of "+a+" operations exceeds the allowed limit of "+t.protocolParameters.maxOperationsPerBatch+".");case 2:return console.info("Downloading anchor file '"+n+"', max file size limit "+t.protocolParameters.maxAnchorFileSizeInBytes+" bytes..."),e.next=5,this.downloadFileFromCas(n,t.protocolParameters.maxAnchorFileSizeInBytes);case 5:return o=e.sent,e.next=8,B.parse(o);case 8:if(!((s=(i=e.sent).didUniqueSuffixes.length)>a)){e.next=12;break}throw new t.SidetreeError(t.ErrorCode.AnchorFileOperationCountExceededPaidLimit,"Operation count "+s+" in anchor file exceeded limit of : "+a);case 12:if(!i.model.writer_lock_id){e.next=18;break}return e.next=15,this.blockchain.getValueTimeLock(i.model.writer_lock_id);case 15:e.t0=e.sent,e.next=19;break;case 18:e.t0=void 0;case 19:return G.verifyLockAmountAndThrowOnError(e.t0,a,r.transactionTime,r.writer,this.versionMetadataFetcher),e.abrupt("return",i);case 22:case"end":return e.stop()}}),e,this)})));return function(r,t,n){return e.apply(this,arguments)}}(),r.downloadAndVerifyMapFile=function(){var e=y(S.mark((function e(r,n){var a,o,i;return S.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,a=r.model,console.info("Downloading map file '"+a.map_file_uri+"', max file size limit "+t.protocolParameters.maxMapFileSizeInBytes+"..."),e.next=5,this.downloadFileFromCas(a.map_file_uri,t.protocolParameters.maxMapFileSizeInBytes);case 5:return o=e.sent,e.next=8,J.parse(o);case 8:if(!(((i=e.sent).updateOperations?i.updateOperations.length:0)>n-r.didUniqueSuffixes.length)){e.next=14;break}return e.abrupt("return",void 0);case 14:if(E.areMutuallyExclusive(r.didUniqueSuffixes,i.didUniqueSuffixes)){e.next=16;break}return e.abrupt("return",void 0);case 16:return e.abrupt("return",i);case 19:if(e.prev=19,e.t0=e.catch(0),!(e.t0 instanceof t.SidetreeError)){e.next=27;break}if(e.t0.code!==t.ErrorCode.CasNotReachable&&e.t0.code!==t.ErrorCode.CasFileNotFound){e.next=24;break}throw e.t0;case 24:return e.abrupt("return",void 0);case 27:return console.error("Unexpected error fetching map file "+r.model.map_file_uri+", MUST investigate and fix: "+t.SidetreeError.stringify(e.t0)),e.abrupt("return",void 0);case 29:case"end":return e.stop()}}),e,this,[[0,19]])})));return function(r,t){return e.apply(this,arguments)}}(),r.downloadAndVerifyChunkFile=function(){var e=y(S.mark((function e(r){var n,a;return S.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(void 0!==r){e.next=2;break}return e.abrupt("return",void 0);case 2:return e.prev=2,n=r.model.chunks[0].chunk_file_uri,console.info("Downloading chunk file '"+n+"', max size limit "+t.protocolParameters.maxChunkFileSizeInBytes+"..."),e.next=7,this.downloadFileFromCas(n,t.protocolParameters.maxChunkFileSizeInBytes);case 7:return a=e.sent,e.next=10,I.parse(a);case 10:return e.abrupt("return",e.sent);case 14:if(e.prev=14,e.t0=e.catch(2),!(e.t0 instanceof t.SidetreeError)){e.next=22;break}if(e.t0.code!==t.ErrorCode.CasNotReachable&&e.t0.code!==t.ErrorCode.CasFileNotFound){e.next=19;break}throw e.t0;case 19:return e.abrupt("return",void 0);case 22:return console.error("Unexpected error fetching chunk file "+n+", MUST investigate and fix: "+t.SidetreeError.stringify(e.t0)),e.abrupt("return",void 0);case 24:case"end":return e.stop()}}),e,this,[[2,14]])})));return function(r){return e.apply(this,arguments)}}(),r.composeAnchoredOperationModels=function(){var e=y(S.mark((function e(r,t,n,a){var o,i,s,c,u,p,d,f,h,l,v,m,y,w,x,b,g,k,E,O;return S.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(i=t.recoverOperations,s=t.deactivateOperations,c=n&&n.updateOperations?n.updateOperations:[],(u=[]).push.apply(u,o=t.createOperations),u.push.apply(u,i),u.push.apply(u,c),u.push.apply(u,s),p=[],void 0===a){e.next=26;break}d=o.length+i.length+c.length,f=0;case 13:if(!(f<d&&f<a.deltas.length)){e.next=26;break}return l=(h=u[f]).operationBuffer.toString(),e.next=18,D.parse(l);case 18:(v=e.sent).type=h.type,v.delta=a.deltas[f],m=Buffer.from(JSON.stringify(v)),p.push(m);case 23:f++,e.next=13;break;case 26:y=0;case 27:if(!(y<s.length)){e.next=39;break}return x=(w=s[y]).operationBuffer.toString(),e.next=32,D.parse(x);case 32:(b=e.sent).type=w.type,g=Buffer.from(JSON.stringify(b)),p.push(g);case 36:y++,e.next=27;break;case 39:for(k=[],E=0;E<u.length;E++)k.push({didUniqueSuffix:(O=u[E]).didUniqueSuffix,type:O.type,operationBuffer:p[E],operationIndex:E,transactionNumber:r.transactionNumber,transactionTime:r.transactionTime});return e.abrupt("return",k);case 42:case"end":return e.stop()}}),e)})));return function(r,t,n,a){return e.apply(this,arguments)}}(),r.downloadFileFromCas=function(){var e=y(S.mark((function e(r,n){var a;return S.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return console.info("Downloading file '"+r+"', max size limit "+n+"..."),e.next=3,this.downloadManager.download(r,n);case 3:if((a=e.sent).code!==t.FetchResultCode.InvalidHash){e.next=6;break}throw new t.SidetreeError(t.ErrorCode.CasFileHashNotValid,"File hash '"+r+"' is not a valid hash.");case 6:if(a.code!==t.FetchResultCode.MaxSizeExceeded){e.next=8;break}throw new t.SidetreeError(t.ErrorCode.CasFileTooLarge,"File '"+r+"' exceeded max size limit of "+n+" bytes.");case 8:if(a.code!==t.FetchResultCode.NotAFile){e.next=10;break}throw new t.SidetreeError(t.ErrorCode.CasFileNotAFile,"File hash '"+r+"' points to a content that is not a file.");case 10:if(a.code!==t.FetchResultCode.CasNotReachable){e.next=12;break}throw new t.SidetreeError(t.ErrorCode.CasNotReachable,"CAS not reachable for file '"+r+"'.");case 12:if(a.code!==t.FetchResultCode.NotFound){e.next=14;break}throw new t.SidetreeError(t.ErrorCode.CasFileNotFound,"File '"+r+"' not found.");case 14:return console.info("File '"+r+"' of size "+a.content.length+" downloaded."),e.abrupt("return",a.content);case 16:case"end":return e.stop()}}),e,this)})));return function(r,t){return e.apply(this,arguments)}}(),e}(),X=function(){function e(e){this.transactionStore=e,this.maxNumberOfOperationsPerBlock=t.protocolParameters.maxNumberOfOperationsPerTransactionTime,this.maxNumberOfTransactionsPerBlock=t.protocolParameters.maxNumberOfTransactionsPerTransactionTime}e.getTransactionPriorityQueue=function(){return new h({comparator:function(e,r){return e.transactionFeePaid-r.transactionFeePaid||r.transactionNumber-e.transactionNumber}})};var r=e.prototype;return r.selectQualifiedTransactions=function(){var r=y(S.mark((function r(t){var n,a,o,i;return S.wrap((function(r){for(;;)switch(r.prev=r.next){case 0:if(t.length){r.next=2;break}return r.abrupt("return",[]);case 2:return n=e.getTransactionPriorityQueue(),e.validateTransactions(t,a=t[0].transactionTime),e.enqueueFirstTransactionFromEachWriter(t,a,n),r.next=8,this.getNumberOfOperationsAndTransactionsAlreadyInTransactionTime(a);case 8:return i=e.getHighestFeeTransactionsFromCurrentTransactionTime(this.maxNumberOfOperationsPerBlock-(o=r.sent)[0],this.maxNumberOfTransactionsPerBlock-o[1],n),r.abrupt("return",i);case 15:case"end":return r.stop()}}),r,this)})));return function(e){return r.apply(this,arguments)}}(),e.validateTransactions=function(e,r){for(var n,a=g(e);!(n=a()).done;)if(n.value.transactionTime!==r)throw new t.SidetreeError(t.ErrorCode.TransactionsNotInSameBlock,"transaction must be in the same block to perform rate limiting, investigate and fix")},e.enqueueFirstTransactionFromEachWriter=function(e,r,t){for(var n,a=new Map,o=g(e);!(n=o()).done;){var i=n.value;if(a.has(i.writer)){var s=a.get(i.writer);console.info("Multiple transactions found in transaction time "+r+" from writer "+i.writer+", considering transaction "+s+" and ignoring "+i.transactionNumber)}else t.push(i),a.set(i.writer,i.transactionNumber)}},r.getNumberOfOperationsAndTransactionsAlreadyInTransactionTime=function(){var e=y(S.mark((function e(r){var n,a,o,i,s,c;return S.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.transactionStore.getTransactionsStartingFrom(r,r);case 2:if(a=0,n=e.sent)for(o=g(n);!(i=o()).done;){s=i.value;try{c=t.AnchoredDataSerializer.deserialize(s.anchorString).numberOfOperations,a+=c}catch(e){console.debug("Error thrown in TransactionSelector: "+JSON.stringify(e,Object.getOwnPropertyNames(e))),console.info("Transaction with anchor string "+s.anchorString+" not considered as selected.")}}return e.abrupt("return",[a,n?n.length:0]);case 7:case"end":return e.stop()}}),e,this)})));return function(r){return e.apply(this,arguments)}}(),e.getHighestFeeTransactionsFromCurrentTransactionTime=function(e,r,n){for(var a=0,o=[];o.length<r&&a<e&&n.length>0;){var i=n.pop();try{(a+=t.AnchoredDataSerializer.deserialize(i.anchorString).numberOfOperations)<=e&&o.push(i)}catch(e){console.debug("Error thrown in TransactionSelector: "+JSON.stringify(e,Object.getOwnPropertyNames(e))),console.info("Transaction with anchor string "+i.anchorString+" not selected")}}return o},e}(),Z=function(){};Z.lightBlue=l.hex("#75b0eb"),Z.green=l.green,Z.yellow=l.yellow;var $=function(){function e(e,r,t,n){this.operationQueue=e,this.blockchain=r,this.cas=t,this.versionMetadataFetcher=n}var r=e.prototype;return r.write=function(){var e=y(S.mark((function e(){var r,n,a,o,i,s,c,u,p,d,f,h,l,v,m,w,x,b,g;return S.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.blockchain.getFee(this.blockchain.approximateTime.time);case 2:return r=e.sent,e.next=5,this.blockchain.getWriterValueTimeLock();case 5:return a=this.getNumberOfOperationsAllowed(n=e.sent),e.next=9,this.operationQueue.peek(a);case 9:if(i=(o=e.sent).length,0!==o.length){e.next=14;break}return console.info("No queued operations to batch."),e.abrupt("return");case 14:return console.info(Z.lightBlue("Batch size = "+Z.green(""+i))),e.next=17,Promise.all(o.map(function(){var e=y(S.mark((function e(r){return S.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",V.parse(r.operationBuffer));case 1:case"end":return e.stop()}}),e)})));return function(r){return e.apply(this,arguments)}}()));case 17:return c=(s=e.sent).filter((function(e){return e.type===t.OperationType.Create})),u=s.filter((function(e){return e.type===t.OperationType.Recover})),p=s.filter((function(e){return e.type===t.OperationType.Update})),d=s.filter((function(e){return e.type===t.OperationType.Deactivate})),e.next=24,I.createBuffer(c,u,p);case 24:return f=e.sent,e.next=27,this.cas.write(f);case 27:return h=e.sent,console.info(Z.lightBlue("Wrote chunk file "+Z.green(h)+" to content addressable store.")),e.next=31,J.createBuffer(h,p);case 31:return l=e.sent,e.next=34,this.cas.write(l);case 34:return v=e.sent,console.info(Z.lightBlue("Wrote map file "+Z.green(v)+" to content addressable store.")),m=n?n.identifier:void 0,e.next=39,B.createBuffer(m,v,c,u,d);case 39:return w=e.sent,e.next=42,this.cas.write(w);case 42:return x=e.sent,console.info(Z.lightBlue("Wrote anchor file "+Z.green(x)+" to content addressable store.")),b=t.AnchoredDataSerializer.serialize({anchorFileHash:x,numberOfOperations:i}),g=Q.computeMinimumTransactionFee(r,i),console.info(Z.lightBlue("Writing data to blockchain: "+Z.green(b)+" with minimum fee of: "+Z.green(""+g))),e.next=50,this.blockchain.write(b,g);case 50:return e.next=52,this.operationQueue.dequeue(o.length);case 52:case"end":return e.stop()}}),e,this)})));return function(){return e.apply(this,arguments)}}(),r.getNumberOfOperationsAllowed=function(e){var r=t.protocolParameters.maxOperationsPerBatch,n=G.calculateMaxNumberOfOperationsAllowed(e,this.versionMetadataFetcher);return n>r&&console.info("Maximum number of operations allowed by value time lock: "+n+"; Maximum number of operations allowed by protocol: "+r),Math.min(n,r)},e}(),ee=function(){function e(){}var r=e.prototype;return r.apply=function(){var e=y(S.mark((function e(r,n){var a,o;return S.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(void 0!==n||r.type===t.OperationType.Create){e.next=2;break}return e.abrupt("return",void 0);case 2:if(a=n?n.lastOperationTransactionNumber:void 0,r.type!==t.OperationType.Create){e.next=9;break}return e.next=6,this.applyCreateOperation(r,n);case 6:o=e.sent,e.next=28;break;case 9:if(r.type!==t.OperationType.Update){e.next=15;break}return e.next=12,this.applyUpdateOperation(r,n);case 12:o=e.sent,e.next=28;break;case 15:if(r.type!==t.OperationType.Recover){e.next=21;break}return e.next=18,this.applyRecoverOperation(r,n);case 18:o=e.sent,e.next=28;break;case 21:if(r.type!==t.OperationType.Deactivate){e.next=27;break}return e.next=24,this.applyDeactivateOperation(r,n);case 24:o=e.sent,e.next=28;break;case 27:throw new t.SidetreeError(t.ErrorCode.OperationProcessorUnknownOperationType);case 28:try{void 0!==o&&o.lastOperationTransactionNumber!==a||console.debug("Ignored invalid operation for DID '"+r.didUniqueSuffix+"' in transaction '"+r.transactionNumber+"' at time '"+r.transactionTime+"' at operation index "+r.operationIndex+".")}catch(e){console.log("Failed logging "+e+".")}return e.abrupt("return",o);case 30:case"end":return e.stop()}}),e,this)})));return function(r,t){return e.apply(this,arguments)}}(),r.getRevealValue=function(){var e=y(S.mark((function e(r){var n,a;return S.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(r.type!==t.OperationType.Create){e.next=2;break}throw new t.SidetreeError(t.ErrorCode.OperationProcessorCreateOperationDoesNotHaveRevealValue);case 2:return e.next=4,V.parse(r.operationBuffer);case 4:e.t0=(n=e.sent).type,e.next=e.t0===t.OperationType.Recover?8:e.t0===t.OperationType.Update?11:14;break;case 8:return a=t.JsonCanonicalizer.canonicalizeAsBuffer(n.signedData.recovery_key),e.abrupt("return",a);case 11:return a=t.JsonCanonicalizer.canonicalizeAsBuffer(n.signedData.update_key),e.abrupt("return",a);case 14:return a=t.JsonCanonicalizer.canonicalizeAsBuffer(n.signedData.recovery_key),e.abrupt("return",a);case 17:case"end":return e.stop()}}),e)})));return function(r){return e.apply(this,arguments)}}(),r.applyCreateOperation=function(){var e=y(S.mark((function e(r,n){var a,o,i;return S.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(void 0===n){e.next=2;break}return e.abrupt("return",n);case 2:return e.next=4,F.parse(r.operationBuffer);case 4:if(t.Multihash.isValidHash((a=e.sent).encodedDelta,a.suffixData.delta_hash)){e.next=8;break}return e.abrupt("return",n);case 8:o=a.delta,i={},e.prev=10,void 0!==o&&(i=C.applyPatches(i,o.patches)),e.next=20;break;case 14:return e.prev=14,e.t0=e.catch(10),console.debug("Unable to apply document patch in transaction number "+r.transactionNumber+" for DID "+r.didUniqueSuffix+": "+t.SidetreeError.stringify(e.t0)+"."),e.abrupt("return",n);case 20:return e.abrupt("return",{didUniqueSuffix:a.didUniqueSuffix,document:i,nextRecoveryCommitmentHash:a.suffixData.recovery_commitment,nextUpdateCommitmentHash:o?o.update_commitment:void 0,lastOperationTransactionNumber:r.transactionNumber});case 22:case"end":return e.stop()}}),e,null,[[10,14]])})));return function(r,t){return e.apply(this,arguments)}}(),r.applyUpdateOperation=function(){var e=y(S.mark((function e(r,n){var a,o;return S.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,K.parse(r.operationBuffer);case 2:if(t.Multihash.canonicalizeAndVerify((a=e.sent).signedData.update_key,n.nextUpdateCommitmentHash)){e.next=6;break}return e.abrupt("return",n);case 6:return e.next=8,a.signedDataJws.verifySignature(a.signedData.update_key);case 8:if(e.sent){e.next=11;break}return e.abrupt("return",n);case 11:if(t.Multihash.isValidHash(a.encodedDelta,a.signedData.delta_hash)){e.next=14;break}return e.abrupt("return",n);case 14:return e.prev=14,e.next=17,C.applyUpdateOperation(a,n.document);case 17:o=e.sent,e.next=26;break;case 20:return e.prev=20,e.t0=e.catch(14),console.debug("Unable to apply document patch in transaction number "+r.transactionNumber+" for DID "+r.didUniqueSuffix+": "+t.SidetreeError.stringify(e.t0)+"."),e.abrupt("return",n);case 26:return e.abrupt("return",{nextRecoveryCommitmentHash:n.nextRecoveryCommitmentHash,document:o,nextUpdateCommitmentHash:a.delta.update_commitment,lastOperationTransactionNumber:r.transactionNumber});case 28:case"end":return e.stop()}}),e,null,[[14,20]])})));return function(r,t){return e.apply(this,arguments)}}(),r.applyRecoverOperation=function(){var e=y(S.mark((function e(r,n){var a,o,i;return S.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,N.parse(r.operationBuffer);case 2:if(t.Multihash.canonicalizeAndVerify((a=e.sent).signedData.recovery_key,n.nextRecoveryCommitmentHash)){e.next=6;break}return e.abrupt("return",n);case 6:return e.next=8,a.signedDataJws.verifySignature(a.signedData.recovery_key);case 8:if(e.sent){e.next=11;break}return e.abrupt("return",n);case 11:if(t.Multihash.isValidHash(a.encodedDelta,a.signedData.delta_hash)){e.next=14;break}return e.abrupt("return",n);case 14:o=a.delta,i={},e.prev=16,void 0!==o&&(i=C.applyPatches(i,o.patches)),e.next=26;break;case 20:return e.prev=20,e.t0=e.catch(16),console.debug("Unable to apply document patch in transaction number "+r.transactionNumber+" for DID "+r.didUniqueSuffix+": "+t.SidetreeError.stringify(e.t0)+"."),e.abrupt("return",n);case 26:return e.abrupt("return",{didUniqueSuffix:a.didUniqueSuffix,document:i,recovery_key:a.signedData.recovery_key,nextRecoveryCommitmentHash:a.signedData.recovery_commitment,nextUpdateCommitmentHash:o?o.update_commitment:void 0,lastOperationTransactionNumber:r.transactionNumber});case 28:case"end":return e.stop()}}),e,null,[[16,20]])})));return function(r,t){return e.apply(this,arguments)}}(),r.applyDeactivateOperation=function(){var e=y(S.mark((function e(r,n){var a;return S.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,_.parse(r.operationBuffer);case 2:if(t.Multihash.canonicalizeAndVerify((a=e.sent).signedData.recovery_key,n.nextRecoveryCommitmentHash)){e.next=6;break}return e.abrupt("return",n);case 6:return e.next=8,a.signedDataJws.verifySignature(a.signedData.recovery_key);case 8:if(e.sent){e.next=11;break}return e.abrupt("return",n);case 11:return e.abrupt("return",{document:n.document,recovery_key:void 0,nextRecoveryCommitmentHash:void 0,nextUpdateCommitmentHash:void 0,lastOperationTransactionNumber:r.transactionNumber});case 13:case"end":return e.stop()}}),e)})));return function(r,t){return e.apply(this,arguments)}}(),e}(),re=function(){function e(e,r){this.didMethodName=r;var n="did:"+r+":";if(!e.startsWith(n))throw new t.SidetreeError(t.ErrorCode.DidIncorrectPrefix);var a=e.indexOf("?");if(this.isShortForm=a<0,this.uniqueSuffix=this.isShortForm?e.substring(n.length):e.substring(n.length,a),0===this.uniqueSuffix.length)throw new t.SidetreeError(t.ErrorCode.DidNoUniqueSuffix);this.shortForm=n+this.uniqueSuffix}return e.create=function(){var r=y(S.mark((function r(n,a){var o,i,s;return S.wrap((function(r){for(;;)switch(r.prev=r.next){case 0:if((o=new e(n,a)).isShortForm){r.next=10;break}return i=e.getInitialStateFromDidString(n,a),r.next=5,e.constructCreateOperationFromInitialState(i);case 5:if(t.Multihash.isValidHash((s=r.sent).encodedSuffixData,o.uniqueSuffix)){r.next=9;break}throw new t.SidetreeError(t.ErrorCode.DidUniqueSuffixFromInitialStateMismatch);case 9:o.createOperation=s;case 10:return r.abrupt("return",o);case 11:case"end":return r.stop()}}),r)})));return function(e,t){return r.apply(this,arguments)}}(),e.getInitialStateFromDidString=function(r,n){var a=void 0;try{a=new v.URL(r)}catch(e){throw new t.SidetreeError(t.ErrorCode.DidInvalidDidString)}for(var o,i,s=n.split(":")[0],c=0,u=g(a.searchParams);!(i=u()).done;){var p=i.value,d=p[0],f=p[1];if((c+=1)>1)throw new t.SidetreeError(t.ErrorCode.DidLongFormOnlyOneQueryParamAllowed);if(d!=="-"+s+"-"+e.initialStateParameterSuffix)throw new t.SidetreeError(t.ErrorCode.DidLongFormOnlyInitialStateParameterIsAllowed);o=f}if(void 0===o)throw new t.SidetreeError(t.ErrorCode.DidLongFormNoInitialStateFound);return o},e.constructCreateOperationFromInitialState=function(){var e=y(S.mark((function e(r){var n,a,o,i;return S.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(-1!==(n=r.indexOf("."))){e.next=3;break}throw new t.SidetreeError(t.ErrorCode.DidInitialStateValueContainsNoDot);case 3:if(r.lastIndexOf(".")===n){e.next=6;break}throw new t.SidetreeError(t.ErrorCode.DidInitialStateValueContainsMoreThanOneDot);case 6:if(n!==r.length-1&&0!==n){e.next=8;break}throw new t.SidetreeError(t.ErrorCode.DidInitialStateValueDoesNotContainTwoParts);case 8:return a=r.split("."),o={type:t.OperationType.Create,suffix_data:a[0],delta:a[1]},i=Buffer.from(JSON.stringify(o)),e.next=15,F.parseObject(o,i,!1);case 15:return e.abrupt("return",e.sent);case 17:case"end":return e.stop()}}),e)})));return function(r){return e.apply(this,arguments)}}(),e}();re.initialStateParameterSuffix="initial-state";var te=function(){function e(e,r,t){this.resolver=e,this.operationQueue=r,this.didMethodName=t,this.operationProcessor=new ee}var r=e.prototype;return r.handleOperationRequest=function(){var e=y(S.mark((function e(r){var n,a,o,i,s;return S.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return console.info("Handling operation request of size "+r.length+" bytes..."),e.prev=1,e.next=4,D.parse(r);case 4:if((a=e.sent).type!==t.OperationType.Create&&a.type!==t.OperationType.Recover&&a.type!==t.OperationType.Update){e.next=11;break}if(!((o=Buffer.from(a.delta)).length>t.protocolParameters.maxDeltaSizeInBytes)){e.next=11;break}throw i="operationDdata byte size of "+o.length+" exceeded limit of "+t.protocolParameters.maxDeltaSizeInBytes,console.info(i),new t.SidetreeError(t.ErrorCode.RequestHandlerDeltaExceedsMaximumSize,i);case 11:return e.next=13,V.parse(r);case 13:return n=e.sent,e.next=16,this.operationQueue.contains(n.didUniqueSuffix);case 16:if(!e.sent){e.next=19;break}throw new t.SidetreeError(t.ErrorCode.QueueingMultipleOperationsPerDidNotAllowed,"An operation request already exists in queue for DID '"+n.didUniqueSuffix+"', only one is allowed at a time.");case 19:e.next=29;break;case 21:if(e.prev=21,e.t0=e.catch(1),!(e.t0 instanceof t.SidetreeError)){e.next=27;break}return console.info("Bad request: "+e.t0.code),console.info("Error message: "+e.t0.message),e.abrupt("return",{status:t.ResponseStatus.BadRequest,body:{code:e.t0.code,message:e.t0.message}});case 27:return console.info("Bad request: "+e.t0),e.abrupt("return",{status:t.ResponseStatus.BadRequest});case 29:e.prev=29,console.info("Operation type: '"+n.type+"', DID unique suffix: '"+n.didUniqueSuffix+"'"),e.t1=n.type,e.next=e.t1===t.OperationType.Create?34:e.t1===t.OperationType.Update||e.t1===t.OperationType.Recover||e.t1===t.OperationType.Deactivate?38:40;break;case 34:return e.next=36,this.handleCreateRequest(n);case 36:return s=e.sent,e.abrupt("break",41);case 38:return s={status:t.ResponseStatus.Succeeded},e.abrupt("break",41);case 40:s={status:t.ResponseStatus.BadRequest,body:{code:t.ErrorCode.RequestHandlerUnknownOperationType,message:"Unsupported operation type '"+n.type+"'."}};case 41:if(s.status!==t.ResponseStatus.Succeeded){e.next=44;break}return e.next=44,this.operationQueue.enqueue(n.didUniqueSuffix,n.operationBuffer);case 44:return e.abrupt("return",s);case 47:if(e.prev=47,e.t2=e.catch(29),!(e.t2 instanceof t.SidetreeError)){e.next=52;break}return console.info("Sidetree error: "+e.t2.code+" "+e.t2.message),e.abrupt("return",{status:t.ResponseStatus.BadRequest,body:{code:e.t2.code,message:e.t2.message}});case 52:return console.info("Unexpected error: "+e.t2),e.abrupt("return",{status:t.ResponseStatus.ServerError});case 54:case"end":return e.stop()}}),e,this,[[1,21],[29,47]])})));return function(r){return e.apply(this,arguments)}}(),r.handleCreateRequest=function(){var e=y(S.mark((function e(r){var n,a;return S.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.applyCreateOperation(r);case 2:if(void 0!==(n=e.sent)){e.next=5;break}return e.abrupt("return",{status:t.ResponseStatus.BadRequest,body:"Invalid create operation."});case 5:return a=C.transformToExternalDocument(n,"did:"+this.didMethodName+":"+r.didUniqueSuffix),e.abrupt("return",{status:t.ResponseStatus.Succeeded,body:a});case 8:case"end":return e.stop()}}),e,this)})));return function(r){return e.apply(this,arguments)}}(),r.handleResolveRequest=function(){var e=y(S.mark((function e(r){var n,a,o;return S.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,console.info("Handling resolution request for: "+r+"..."),e.next=4,re.create(r,this.didMethodName);case 4:if(!(n=e.sent).isShortForm){e.next=11;break}return e.next=8,this.resolver.resolve(n.uniqueSuffix);case 8:a=e.sent,e.next=14;break;case 11:return e.next=13,this.resolveLongFormDid(n);case 13:a=e.sent;case 14:if(void 0!==a){e.next=16;break}return e.abrupt("return",{status:t.ResponseStatus.NotFound});case 16:return o=C.transformToExternalDocument(a,r),e.abrupt("return",{status:t.ResponseStatus.Succeeded,body:o});case 20:if(e.prev=20,e.t0=e.catch(0),!(e.t0 instanceof t.SidetreeError)){e.next=24;break}return e.abrupt("return",{status:t.ResponseStatus.BadRequest,body:{code:e.t0.code,message:e.t0.message}});case 24:return console.info("Unexpected error: "+e.t0),e.abrupt("return",{status:t.ResponseStatus.ServerError});case 26:case"end":return e.stop()}}),e,this,[[0,20]])})));return function(r){return e.apply(this,arguments)}}(),r.resolveLongFormDid=function(){var e=y(S.mark((function e(r){var t;return S.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.resolver.resolve(r.uniqueSuffix);case 2:if(void 0===(t=e.sent)){e.next=5;break}return e.abrupt("return",t);case 5:return e.next=7,this.applyCreateOperation(r.createOperation);case 7:return e.abrupt("return",t=e.sent);case 9:case"end":return e.stop()}}),e,this)})));return function(r){return e.apply(this,arguments)}}(),r.applyCreateOperation=function(){var e=y(S.mark((function e(r){var n;return S.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return n={didUniqueSuffix:r.didUniqueSuffix,type:t.OperationType.Create,transactionTime:0,transactionNumber:0,operationIndex:0,operationBuffer:r.operationBuffer},e.next=3,this.operationProcessor.apply(n,void 0);case 3:return e.abrupt("return",e.sent);case 5:case"end":return e.stop()}}),e,this)})));return function(r){return e.apply(this,arguments)}}(),e}(),ne=function(e){var r,n;function a(){var r;return(r=e.call(this)||this).hashAlgorithmInMultihashCode=t.protocolParameters.hashAlgorithmInMultihashCode,r.normalizedFeeToPerOperationFeeMultiplier=t.protocolParameters.normalizedFeeToPerOperationFeeMultiplier,r.valueTimeLockAmountMultiplier=t.protocolParameters.valueTimeLockAmountMultiplier,r}return n=e,(r=a).prototype=Object.create(n.prototype),r.prototype.constructor=r,x(r,n),a}(t.AbstractVersionMetadata),ae=function(){function e(e,r){this.config=e,this.allSupportedHashAlgorithms=[],this.protocolVersionsReverseSorted=r.sort((function(e,r){return r.startingBlockchainTime-e.startingBlockchainTime})),this.batchWriters=new Map,this.operationProcessors=new Map,this.operationQueues=new Map,this.requestHandlers=new Map,this.transactionProcessors=new Map,this.transactionSelectors=new Map,this.versionMetadatas=new Map}var n=e.prototype;return n.initialize=function(){var e=y(S.mark((function e(r,n,a,o,i,s){var c,u,p,d,f,h,l,v,m,y,w;return S.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:c=g(this.protocolVersionsReverseSorted);case 1:if((u=c()).done){e.next=45;break}return p=u.value.version,e.next=6,this.loadDefaultExportsForVersion(p,"MongoDbOperationQueue");case 6:return d=new(0,e.sent)(this.config.mongoDbConnectionString,this.config.databaseName),e.next=10,d.initialize();case 10:return this.operationQueues.set(p,d),e.next=13,this.loadDefaultExportsForVersion(p,"TransactionProcessor");case 13:return f=new(0,e.sent)(a,o,r,this),this.transactionProcessors.set(p,f),e.next=18,this.loadDefaultExportsForVersion(p,"TransactionSelector");case 18:return h=new(0,e.sent)(s),this.transactionSelectors.set(p,h),e.next=23,this.loadDefaultExportsForVersion(p,"BatchWriter");case 23:return l=new(0,e.sent)(d,r,n,this),this.batchWriters.set(p,l),e.next=28,this.loadDefaultExportsForVersion(p,"OperationProcessor");case 28:return v=new(0,e.sent),this.operationProcessors.set(p,v),e.next=33,this.loadDefaultExportsForVersion(p,"RequestHandler");case 33:return m=new(0,e.sent)(i,d,this.config.didMethodName),this.requestHandlers.set(p,m),e.next=38,this.loadDefaultExportsForVersion(p,"VersionMetadata");case 38:if((y=new(0,e.sent))instanceof t.AbstractVersionMetadata){e.next=42;break}throw new t.SidetreeError(t.CoreErrorCode.VersionManagerVersionMetadataIncorrectType,"make sure VersionMetaData is properly implemented for version "+p);case 42:this.versionMetadatas.set(p,y);case 43:e.next=1;break;case 45:w=Array.from(this.versionMetadatas.values(),(function(e){return e.hashAlgorithmInMultihashCode})),this.allSupportedHashAlgorithms=Array.from(new Set(w));case 47:case"end":return e.stop()}}),e,this)})));return function(r,t,n,a,o,i){return e.apply(this,arguments)}}(),n.getBatchWriter=function(e){var r=this.getVersionString(e),n=this.batchWriters.get(r);if(void 0===n)throw new t.SidetreeError(t.CoreErrorCode.VersionManagerBatchWriterNotFound,"Batch writer for blockchain time "+e+" not found.");return n},n.getOperationProcessor=function(e){var r=this.getVersionString(e),n=this.operationProcessors.get(r);if(void 0===n)throw new t.SidetreeError(t.CoreErrorCode.VersionManagerOperationProcessorNotFound,"Operation processor for blockchain time "+e+" not found.");return n},n.getRequestHandler=function(e){var r=this.getVersionString(e),n=this.requestHandlers.get(r);if(void 0===n)throw new t.SidetreeError(t.CoreErrorCode.VersionManagerRequestHandlerNotFound,"Request handler for blockchain time "+e+" not found.");return n},n.getTransactionProcessor=function(e){var r=this.getVersionString(e),n=this.transactionProcessors.get(r);if(void 0===n)throw new t.SidetreeError(t.CoreErrorCode.VersionManagerTransactionProcessorNotFound,"Transaction processor for blockchain time "+e+" not found.");return n},n.getTransactionSelector=function(e){var r=this.getVersionString(e),n=this.transactionSelectors.get(r);if(void 0===n)throw new t.SidetreeError(t.CoreErrorCode.VersionManagerTransactionSelectorNotFound,"Transaction selector for blockchain time "+e+" not found.");return n},n.getVersionMetadata=function(e){var r=this.getVersionString(e);return this.versionMetadatas.get(r)},n.getOperationQueue=function(e){var r=this.getVersionString(e);return this.operationQueues.get(r)},n.getVersionString=function(e){for(var r,n=g(this.protocolVersionsReverseSorted);!(r=n()).done;){var a=r.value;if(e>=a.startingBlockchainTime)return a.version}throw new t.SidetreeError(t.CoreErrorCode.VersionManagerVersionStringNotFound,"Unable to find version string for blockchain time "+e+".")},n.loadDefaultExportsForVersion=function(){var e=y(S.mark((function e(t,n){return S.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if("latest"!==t){e.next=12;break}e.t0=n,e.next="MongoDbOperationQueue"===e.t0?4:"TransactionProcessor"===e.t0?5:"TransactionSelector"===e.t0?6:"BatchWriter"===e.t0?7:"OperationProcessor"===e.t0?8:"RequestHandler"===e.t0?9:"VersionMetadata"===e.t0?10:11;break;case 4:return e.abrupt("return",f.MongoDbOperationQueue);case 5:return e.abrupt("return",Y);case 6:return e.abrupt("return",X);case 7:return e.abrupt("return",$);case 8:return e.abrupt("return",ee);case 9:return e.abrupt("return",te);case 10:return e.abrupt("return",ne);case 11:return e.abrupt("return");case 12:return e.next=14,new Promise((function(e){e(r(require("./versions/"+t+"/"+n)))}));case 14:return e.abrupt("return",e.sent.default);case 15:case"end":return e.stop()}}),e)})));return function(r,t){return e.apply(this,arguments)}}(),e}();exports.AnchorFile=B,exports.BatchScheduler=q,exports.ChunkFile=I,exports.Compressor=P,exports.CreateOperation=F,exports.DeactivateOperation=_,exports.DownloadManager=R,exports.JsonAsync=D,exports.Jwk=A,exports.Jws=U,exports.MapFile=J,exports.Observer=L,exports.Operation=V,exports.OperationGenerator=H,exports.RecoverOperation=N,exports.Resolver=z,exports.ServiceInfo=W,exports.TransactionProcessor=Y,exports.UpdateOperation=K,exports.VersionManager=ae;
//# sourceMappingURL=core.cjs.production.min.js.map
