"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var e,t,r=require("factory.ts"),n=require("minimal-cipher"),o=(e=require("isomorphic-webcrypto"))&&"object"==typeof e&&"default"in e?e.default:e,i=require("@transmute/did-key-x25519"),c=require("@transmute/did-key-ed25519");function s(){return(s=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var r=arguments[t];for(var n in r)Object.prototype.hasOwnProperty.call(r,n)&&(e[n]=r[n])}return e}).apply(this,arguments)}!function(e){e.Locked="LOCKED",e.Unlocked="UNLOCKED"}(t||(t={}));const u=function(){function e(){}return e.prototype.then=function(t,r){const n=new e,o=this.s;if(o){const e=1&o?t:r;if(e){try{a(n,1,e(this.v))}catch(e){a(n,2,e)}return n}return this}return this.o=function(e){try{const o=e.v;1&e.s?a(n,1,t?t(o):o):r?a(n,1,r(o)):a(n,2,o)}catch(e){a(n,2,e)}},n},e}();function a(e,t,r){if(!e.s){if(r instanceof u){if(!r.s)return void(r.o=a.bind(null,e,t));1&t&&(t=r.s),r=r.v}if(r&&r.then)return void r.then(a.bind(null,e,t),a.bind(null,e,2));e.s=t,e.v=r;const n=e.o;n&&n(e)}}"undefined"!=typeof Symbol&&(Symbol.iterator||(Symbol.iterator=Symbol("Symbol.iterator"))),"undefined"!=typeof Symbol&&(Symbol.asyncIterator||(Symbol.asyncIterator=Symbol("Symbol.asyncIterator")));var l=function(e){try{return Promise.resolve(o.subtle.digest("SHA-256",e)).then((function(e){return"urn:digest:"+Buffer.from(new Int8Array(e)).toString("hex")}))}catch(e){return Promise.reject(e)}},f=function(e,t,r,n){void 0===t&&(t="salt"),void 0===r&&(r=1e5),void 0===n&&(n="SHA-256");try{var i=Buffer.from(t),c=Buffer.from(e);return Promise.resolve(o.subtle.importKey("raw",c,{name:"PBKDF2"},!1,["deriveBits","deriveKey"]).then((function(e){return o.subtle.deriveKey({name:"PBKDF2",salt:i,iterations:r,hash:n},e,{name:"AES-CBC",length:256},!0,["encrypt","decrypt"])})).then((function(e){return o.subtle.exportKey("raw",e)})).then((function(e){return new Uint8Array(e)})))}catch(e){return Promise.reject(e)}},d=function(e){try{return Promise.resolve(c.Ed25519KeyPair.generate({secureRandom:function(){return e}})).then((function(e){return Promise.resolve(c.driver.resolve(e.controller)).then((function(t){var r=s({},t.didDocument),n=e.toX25519KeyPair(!0);return r.verificationMethod[0].privateKeyBase58=e.toKeyPair(!0).privateKeyBase58,r.verificationMethod[1].privateKeyBase58=n.toKeyPair(!0).privateKeyBase58,r}))}))}catch(e){return Promise.reject(e)}},y=function(e){return delete e.verificationMethod[0].privateKeyBase58,delete e.verificationMethod[1].privateKeyBase58,s({},e)},h=function(e){var t=e.verificationMethod[1];return function(r){var n=r.id;if(t.id===n)return t;throw new Error("Key "+n+" not found in "+e.id)}},v=function(e){var t=e.content,r=e.cipher,n=e.recipients,o=e.keyResolver;try{return Promise.resolve(r.encryptObject({obj:t,recipients:n,keyResolver:o}))}catch(e){return Promise.reject(e)}},p=function(e){var t=e.content,r=e.cipher,n=e.keyAgreementKey;try{return Promise.resolve(r.decryptObject({jwe:t,keyAgreementKey:new i.X25519KeyPair(n)}))}catch(e){return Promise.reject(e)}},m=function(e,t){try{return Promise.resolve(f(e)).then((function(e){return Promise.resolve(d(e)).then((function(e){var r=y(e),o=r.verificationMethod[1];0===o.id.indexOf("#")&&(o.id=o.controller+o.id);var i=[{header:{kid:o.id,alg:"ECDH-ES+A256KW"}}],c=h(r),u=new n.Cipher;return Promise.all(t.map((function(e){return v({content:s({},e),cipher:u,recipients:[].concat(i),keyResolver:c})})))}))}))}catch(e){return Promise.reject(e)}},P=function(e,t){try{return Promise.resolve(f(e)).then((function(e){return Promise.resolve(d(e)).then((function(e){var r=e.verificationMethod[1];0===r.id.indexOf("#")&&(r.id=r.controller+r.id);var o=new n.Cipher,i=[],c=function(e,t,r){var n,o,i=-1;return function r(c){try{for(;++i<e.length;)if((c=t(i))&&c.then){if(!((s=c)instanceof u&&1&s.s))return void c.then(r,o||(o=a.bind(null,n=new u,2)));c=c.v}n?a(n,1,c):n=c}catch(e){a(n||(n=new u),2,e)}var s}(),n}(t,(function(e){return Promise.resolve(p({content:t[e],cipher:o,keyAgreementKey:r})).then((function(e){i.push(e)}))}));return c&&c.then?c.then((function(){return i})):i}))}))}catch(e){return Promise.reject(e)}},w={status:t.Unlocked,contents:[],passwordToKey:f,seedToId:l,add:function(e){return this.contents.push(e),this},remove:function(e){var t=JSON.parse(JSON.stringify(this.contents)),r=t.findIndex((function(t){return t.id===e})),n=t[r];return this.contents=t.filter((function(e){return e.id!==n.id})),n},lock:function(e){try{var r=this;return Promise.resolve(m(e,r.contents)).then((function(e){return r.contents=e,r.status=t.Locked,r}))}catch(e){return Promise.reject(e)}},unlock:function(e){try{var r=this;return Promise.resolve(P(e,r.contents)).then((function(e){return r.contents=e,r.status=t.Unlocked,r}))}catch(e){return Promise.reject(e)}},export:function(e){try{var t=this;return Promise.resolve(f(e)).then((function(r){return Promise.resolve(d(r)).then((function(r){return Promise.resolve(m(e,[{contents:t.contents}])).then((function(e){return{"@context":["https://www.w3.org/2018/credentials/v1","http://w3id.org/wallet/v1"],id:r.id+"#encrypted-wallet",type:["VerifiableCredential","EncryptedWallet"],issuer:r.id,issuanceDate:(new Date).toISOString(),credentialSubject:{id:r.id,encryptedWalletContents:e[0]}}}))}))}))}catch(e){return Promise.reject(e)}},import:function(e,r){try{var n=this;if(n.contents.length)throw new Error("Cannot import over existing wallet content.");return Promise.resolve(P(r,[e.credentialSubject.encryptedWalletContents])).then((function(e){return n.contents=e[0].contents,n.status=t.Unlocked,n}))}catch(e){return Promise.reject(e)}},query:function(e,r,n){if(this.status!==t.Unlocked)throw new Error("You can only query an unlocked wallet.");var o=this.contents.map(e);return r?o.reduce(r,n):o}},b=r.Sync.makeFactory(w);exports.getKeyResolver=h,exports.lockContent=v,exports.lockContents=m,exports.lockDidKey=y,exports.passwordToKey=f,exports.seedToId=l,exports.unlockContent=p,exports.unlockContents=P,exports.unlockDidKey=d,exports.walletDefaults=w,exports.walletFactory=b;
//# sourceMappingURL=universal-wallet.cjs.production.min.js.map
